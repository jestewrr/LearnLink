@{
    ViewData["Title"] = "Lessons Learned";
    ViewData["ActivePage"] = "LessonsLearned";

    var lessons = ViewBag.Lessons as List<LearnLink.Models.LessonViewModel> ?? new List<LearnLink.Models.LessonViewModel>();
    var totalLessons = (int)(ViewBag.TotalLessons ?? 0);
    var totalContributors = (int)(ViewBag.TotalContributors ?? 0);
    var totalCategories = (int)(ViewBag.TotalCategories ?? 0);

    string[] iconGradients = {
        "background: linear-gradient(135deg, #fef3c7, #fbbf24)",
        "background: linear-gradient(135deg, #d1fae5, #10b981)",
        "background: linear-gradient(135deg, #dbeafe, #3b82f6)",
        "background: linear-gradient(135deg, #fce7f3, #ec4899)",
        "background: linear-gradient(135deg, #e0e7ff, #6366f1)"
    };
    string[] iconColors = { "text-warning", "text-success", "text-primary", "text-danger", "text-info" };
}

<!-- Page Header -->
<div class="ll-page-header">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
        <div>
            <h1 class="ll-page-title">Lessons Learned</h1>
            <div class="ll-breadcrumb">
                <a href="@Url.Action("Dashboard", "Home")">Home</a>
                <i class="bi bi-chevron-right small"></i>
                <span>Lessons Learned</span>
            </div>
        </div>
        <div class="d-flex gap-2">
            <button class="ll-btn ll-btn-primary" data-bs-toggle="modal" data-bs-target="#submitLessonModal">
                <i class="bi bi-plus-circle"></i>
                Submit Lesson Learned
            </button>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Main Content -->
    <div class="col-lg-8">
        <!-- Filter Tabs -->
        <div class="ll-card mb-4">
            <div class="ll-card-body py-2">
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    <button class="ll-btn ll-btn-primary ll-btn-sm lesson-sort-btn active" data-sort="">All Lessons</button>
                    <button class="ll-btn ll-btn-outline ll-btn-sm lesson-sort-btn" data-sort="likes">Top Rated</button>
                    <button class="ll-btn ll-btn-outline ll-btn-sm lesson-sort-btn" data-sort="recent">Recent</button>
                    <div class="ms-auto">
                        <select class="ll-form-control ll-form-select" style="width: auto;" id="lessonCategoryFilter">
                            <option value="">All Categories</option>
                            @foreach (var category in lessons.Select(l => l.Category).Distinct())
                            {
                            <option>@category</option>
                            }
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lessons List -->
        <div id="lessonsList">
        @for (int i = 0; i < lessons.Count; i++)
        {
            var lesson = lessons[i];
            var gradientIndex = i % iconGradients.Length;
        <div class="ll-card mb-3 lesson-item" data-category="@lesson.Category" data-likes="@lesson.LikeCount" data-date="@lesson.CreatedAt.ToString("yyyy-MM-dd")">
            <div class="ll-card-body">
                <div class="d-flex gap-3">
                    <div style="width: 48px; height: 48px; @iconGradients[gradientIndex]; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="bi bi-lightbulb @iconColors[gradientIndex] fs-5"></i>
                    </div>
                    <div class="flex-fill">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="fw-bold mb-1">@lesson.Title</h6>
                                <div class="small text-muted">Category: @lesson.Category</div>
                            </div>
                        </div>
                        <p class="text-muted mb-3">@lesson.Content</p>
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            @foreach (var tag in lesson.Tags)
                            {
                            <span class="ll-tag">@tag</span>
                            }
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-2">
                                <div class="ll-discussion-avatar" style="width: 28px; height: 28px; font-size: 0.7rem; @(string.IsNullOrEmpty(lesson.AuthorColor) ? "" : lesson.AuthorColor)">@lesson.AuthorInitials</div>
                                <span class="small text-muted">@lesson.Author â€¢ @((DateTime.Now - lesson.CreatedAt).Days) days ago</span>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="ll-btn ll-btn-outline ll-btn-sm like-btn"><i class="bi bi-hand-thumbs-up"></i> @lesson.LikeCount</button>
                                <button class="ll-btn ll-btn-outline ll-btn-sm"><i class="bi bi-chat"></i> @lesson.CommentCount</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        }
        </div>

        <!-- Pagination -->
        <nav aria-label="Lessons pagination" class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item disabled"><a class="page-link" href="#"><i class="bi bi-chevron-left"></i></a></li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#"><i class="bi bi-chevron-right"></i></a></li>
            </ul>
        </nav>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Stats -->
        <div class="ll-card mb-4">
            <div class="ll-card-header">
                <h5 class="ll-card-title">Contribution Stats</h5>
            </div>
            <div class="ll-card-body">
                <div class="row g-3 text-center">
                    <div class="col-6">
                        <div class="p-3 bg-light rounded">
                            <div class="fs-4 fw-bold text-primary">@totalLessons</div>
                            <div class="small text-muted">Total Lessons</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 bg-light rounded">
                            <div class="fs-4 fw-bold text-success">@lessons.Sum(l => l.LikeCount)</div>
                            <div class="small text-muted">Total Likes</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 bg-light rounded">
                            <div class="fs-4 fw-bold text-warning">@totalContributors</div>
                            <div class="small text-muted">Contributors</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 bg-light rounded">
                            <div class="fs-4 fw-bold text-info">@totalCategories</div>
                            <div class="small text-muted">Categories</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Submit Lesson Modal -->
<div class="modal fade" id="submitLessonModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Submit a Lesson Learned</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="ll-form-group">
                    <label class="ll-form-label">Category</label>
                    <select class="ll-form-control ll-form-select" id="lessonCategory" required>
                        <option value="">Select a category</option>
                        <option>Teaching Strategies</option>
                        <option>Technology Integration</option>
                        <option>Reading Skills</option>
                        <option>Classroom Management</option>
                        <option>Assessment</option>
                    </select>
                </div>
                <div class="ll-form-group">
                    <label class="ll-form-label">Title</label>
                    <input type="text" class="ll-form-control" id="lessonTitle" placeholder="Give your lesson a clear title" required>
                </div>
                <div class="ll-form-group">
                    <label class="ll-form-label">Your Insight</label>
                    <textarea class="ll-form-control" rows="5" id="lessonContent" placeholder="Share what you learned, what worked well, any tips for others..." required></textarea>
                </div>
                <div class="ll-form-group">
                    <label class="ll-form-label">Tags</label>
                    <input type="text" class="ll-form-control" id="lessonTags" placeholder="Add tags separated by commas">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="ll-btn ll-btn-outline" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="ll-btn ll-btn-primary" id="submitLessonBtn">
                    <i class="bi bi-send"></i>
                    Submit Lesson
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080;">
    <div id="lessonToast" class="toast" role="alert">
        <div class="toast-header bg-success text-white">
            <i class="bi bi-check-circle me-2"></i>
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">Your lesson has been submitted successfully!</div>
    </div>
</div>

@section Scripts {
<script>
    (function() {
        const sortBtns = document.querySelectorAll('.lesson-sort-btn');
        const categoryFilter = document.getElementById('lessonCategoryFilter');
        const items = document.querySelectorAll('.lesson-item');
        const lessonsList = document.getElementById('lessonsList');

        function filterAndSort() {
            const activeBtn = document.querySelector('.lesson-sort-btn.active');
            const sortBy = activeBtn ? activeBtn.dataset.sort : '';
            const category = categoryFilter.value;

            const arr = Array.from(items);
            arr.forEach(item => {
                const matchCategory = !category || item.dataset.category === category;
                item.classList.toggle('d-none', !matchCategory);
            });

            if (sortBy === 'likes') {
                arr.sort((a, b) => parseInt(b.dataset.likes) - parseInt(a.dataset.likes));
            } else if (sortBy === 'recent') {
                arr.sort((a, b) => b.dataset.date.localeCompare(a.dataset.date));
            }
            arr.forEach(item => lessonsList.appendChild(item));
        }

        sortBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                sortBtns.forEach(b => { b.classList.remove('ll-btn-primary', 'active'); b.classList.add('ll-btn-outline'); });
                this.classList.remove('ll-btn-outline');
                this.classList.add('ll-btn-primary', 'active');
                filterAndSort();
            });
        });
        categoryFilter.addEventListener('change', filterAndSort);

        // Like buttons
        document.querySelectorAll('.like-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const text = this.textContent.trim();
                const count = parseInt(text.match(/\d+/)?.[0] || '0');
                if (!this.classList.contains('liked')) {
                    this.innerHTML = '<i class="bi bi-hand-thumbs-up-fill"></i> ' + (count + 1);
                    this.classList.add('liked', 'll-btn-primary');
                    this.classList.remove('ll-btn-outline');
                } else {
                    this.innerHTML = '<i class="bi bi-hand-thumbs-up"></i> ' + (count - 1);
                    this.classList.remove('liked', 'll-btn-primary');
                    this.classList.add('ll-btn-outline');
                }
            });
        });

        // Submit lesson
        document.getElementById('submitLessonBtn').addEventListener('click', function() {
            const title = document.getElementById('lessonTitle').value;
            const content = document.getElementById('lessonContent').value;
            if (!title || !content) { alert('Please fill in the title and insight fields.'); return; }
            var modal = bootstrap.Modal.getInstance(document.getElementById('submitLessonModal'));
            modal.hide();
            var toast = new bootstrap.Toast(document.getElementById('lessonToast'));
            toast.show();
            document.getElementById('lessonTitle').value = '';
            document.getElementById('lessonContent').value = '';
            document.getElementById('lessonTags').value = '';
        });
    })();
</script>
}
