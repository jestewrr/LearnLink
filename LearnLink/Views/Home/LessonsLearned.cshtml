@{
    ViewData["Title"] = "Lessons Learned";
    ViewData["ActivePage"] = "LessonsLearned";

    var lessons = ViewBag.Lessons as List<LearnLink.Models.LessonViewModel> ?? new List<LearnLink.Models.LessonViewModel>();
    var totalLessons = (int)(ViewBag.TotalLessons ?? 0);
    var totalContributors = (int)(ViewBag.TotalContributors ?? 0);
    var totalCategories = (int)(ViewBag.TotalCategories ?? 0);

    string[] iconGradients = {
        "background: linear-gradient(135deg, #fef3c7, #fbbf24)",
        "background: linear-gradient(135deg, #d1fae5, #10b981)",
        "background: linear-gradient(135deg, #dbeafe, #3b82f6)",
        "background: linear-gradient(135deg, #fce7f3, #ec4899)",
        "background: linear-gradient(135deg, #e0e7ff, #6366f1)"
    };
    string[] iconColors = { "text-warning", "text-success", "text-primary", "text-danger", "text-info" };
}

<!-- Page Header -->
<div class="ll-page-header">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
        <div>
            <h1 class="ll-page-title">Lessons Learned</h1>
            <div class="ll-breadcrumb">
                <a href="@Url.Action("Dashboard", "Home")">Home</a>
                <i class="bi bi-chevron-right small"></i>
                <span>Lessons Learned</span>
            </div>
        </div>
        <div class="d-flex gap-2">
            <button class="ll-btn ll-btn-primary" data-bs-toggle="modal" data-bs-target="#submitLessonModal">
                <i class="bi bi-plus-circle"></i>
                Submit Lesson Learned
            </button>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Main Content -->
    <div class="col-lg-8">
        <!-- Filter Tabs -->
        <div class="ll-card mb-4">
            <div class="ll-card-body py-2">
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    <button class="ll-btn ll-btn-primary ll-btn-sm lesson-sort-btn active" data-sort="">All Lessons</button>
                    <button class="ll-btn ll-btn-outline ll-btn-sm lesson-sort-btn" data-sort="likes">Top Rated</button>
                    <button class="ll-btn ll-btn-outline ll-btn-sm lesson-sort-btn" data-sort="recent">Recent</button>
                    <div class="ms-auto">
                        <select class="ll-form-control ll-form-select" style="width: auto;" id="lessonCategoryFilter">
                            <option value="">All Categories</option>
                            @foreach (var category in lessons.Select(l => l.Category).Distinct())
                            {
                            <option>@category</option>
                            }
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lessons List -->
        <div id="lessonsList">
        @for (int i = 0; i < lessons.Count; i++)
        {
            var lesson = lessons[i];
            var gradientIndex = i % iconGradients.Length;
        <div class="ll-card mb-3 lesson-item" data-category="@lesson.Category" data-likes="@lesson.LikeCount" data-date="@lesson.CreatedAt.ToString("yyyy-MM-dd")">
            <div class="ll-card-body">
                <div class="d-flex gap-3">
                    <div style="width: 48px; height: 48px; @iconGradients[gradientIndex]; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="bi bi-lightbulb @iconColors[gradientIndex] fs-5"></i>
                    </div>
                    <div class="flex-fill">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="fw-bold mb-1">@lesson.Title</h6>
                                <div class="small text-muted">Category: @lesson.Category</div>
                            </div>
                        </div>
                        <p class="text-muted mb-3">@lesson.Content</p>
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            @foreach (var tag in lesson.Tags)
                            {
                            <span class="ll-tag">@tag</span>
                            }
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-2">
                                <div class="ll-discussion-avatar" style="width: 28px; height: 28px; font-size: 0.7rem; @(string.IsNullOrEmpty(lesson.AuthorColor) ? "" : lesson.AuthorColor)">@lesson.AuthorInitials</div>
                                <span class="small text-muted">@lesson.Author â€¢ @((DateTime.Now - lesson.CreatedAt).Days) days ago</span>
                            </div>
                            <div class="d-flex gap-2">
                                @if (User.Identity?.Name == lesson.Author || lesson.Author == "Jester" || lesson.Author == "You") 
                                {
                                    <button class="ll-btn ll-btn-outline ll-btn-sm edit-lesson-btn" 
                                            data-id="@lesson.Id" 
                                            data-title="@lesson.Title" 
                                            data-content="@lesson.Content" 
                                            data-category="@lesson.Category" 
                                            data-tags="@string.Join(", ", lesson.Tags)">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="ll-btn ll-btn-outline ll-btn-sm text-danger delete-lesson-btn" data-id="@lesson.Id">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                }
                                <button class="ll-btn ll-btn-outline ll-btn-sm like-btn" data-id="@lesson.Id"><i class="bi bi-hand-thumbs-up@(lesson.LikeCount > 0 ? "-fill" : "")"></i> @lesson.LikeCount</button>
                                <button class="ll-btn ll-btn-outline ll-btn-sm"><i class="bi bi-chat"></i> @lesson.CommentCount</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        }
        </div>

        <!-- Pagination -->
        <nav aria-label="Lessons pagination" class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item disabled"><a class="page-link" href="#"><i class="bi bi-chevron-left"></i></a></li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#"><i class="bi bi-chevron-right"></i></a></li>
            </ul>
        </nav>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Stats -->
        <div class="ll-card mb-4">
            <div class="ll-card-header">
                <h5 class="ll-card-title">Contribution Stats</h5>
            </div>
            <div class="ll-card-body">
                <div class="row g-3 text-center">
                    <div class="col-6">
                        <div class="p-3 bg-light rounded">
                            <div class="fs-4 fw-bold text-primary">@totalLessons</div>
                            <div class="small text-muted">Total Lessons</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 bg-light rounded">
                            <div class="fs-4 fw-bold text-success">@lessons.Sum(l => l.LikeCount)</div>
                            <div class="small text-muted">Total Likes</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 bg-light rounded">
                            <div class="fs-4 fw-bold text-warning">@totalContributors</div>
                            <div class="small text-muted">Contributors</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 bg-light rounded">
                            <div class="fs-4 fw-bold text-info">@totalCategories</div>
                            <div class="small text-muted">Categories</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Submit Lesson Modal -->
<div class="modal fade" id="submitLessonModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form asp-action="SubmitLesson" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Submit a Lesson Learned</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="ll-form-group">
                        <label class="ll-form-label">Category</label>
                        <select class="ll-form-control ll-form-select" name="Category" required>
                            <option value="">Select a category</option>
                            <option>Teaching Strategies</option>
                            <option>Technology Integration</option>
                            <option>Reading Skills</option>
                            <option>Classroom Management</option>
                            <option>Assessment</option>
                        </select>
                    </div>
                    <div class="ll-form-group">
                        <label class="ll-form-label">Title</label>
                        <input type="text" class="ll-form-control" name="Title" placeholder="Give your lesson a clear title" required>
                    </div>
                    <div class="ll-form-group">
                        <label class="ll-form-label">Your Insight</label>
                        <textarea class="ll-form-control" rows="5" name="Content" placeholder="Share what you learned, what worked well, any tips for others..." required></textarea>
                    </div>
                    <div class="ll-form-group">
                        <label class="ll-form-label">Tags</label>
                        <input type="text" class="ll-form-control" name="Tags" placeholder="Add tags separated by commas" value="General">
                        
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="ll-btn ll-btn-outline" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="ll-btn ll-btn-primary">
                        <i class="bi bi-send"></i>
                        Submit Lesson
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Lesson Modal -->
<div class="modal fade" id="editLessonModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form asp-action="EditLesson" method="post">
                <input type="hidden" name="id" id="editLessonId">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Lesson</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="ll-form-group">
                        <label class="ll-form-label">Category</label>
                        <select class="ll-form-control ll-form-select" name="Category" id="editLessonCategory" required>
                            <option value="">Select a category</option>
                            <option>Teaching Strategies</option>
                            <option>Technology Integration</option>
                            <option>Reading Skills</option>
                            <option>Classroom Management</option>
                            <option>Assessment</option>
                        </select>
                    </div>
                    <div class="ll-form-group">
                        <label class="ll-form-label">Title</label>
                        <input type="text" class="ll-form-control" name="Title" id="editLessonTitle" required>
                    </div>
                    <div class="ll-form-group">
                        <label class="ll-form-label">Your Insight</label>
                        <textarea class="ll-form-control" rows="5" name="Content" id="editLessonContent" required></textarea>
                    </div>
                    <div class="ll-form-group">
                        <label class="ll-form-label">Tags</label>
                        <input type="text" class="ll-form-control" name="Tags" id="editLessonTags">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="ll-btn ll-btn-outline" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="ll-btn ll-btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Lesson Modal -->
<div class="modal fade" id="deleteLessonModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form asp-action="DeleteLesson" method="post">
                <input type="hidden" name="id" id="deleteLessonId">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title">Delete Lesson?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Are you sure you want to delete this lesson? This action cannot be undone.</p>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="ll-btn ll-btn-outline" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="ll-btn ll-btn-danger">Delete Lesson</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080;">
    <div id="lessonToast" class="toast" role="alert">
        <div class="toast-header bg-success text-white">
            <i class="bi bi-check-circle me-2"></i>
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">@TempData["SuccessMessage"]</div>
    </div>
</div>

@section Scripts {
<script>
    (function() {
        const sortBtns = document.querySelectorAll('.lesson-sort-btn');
        const categoryFilter = document.getElementById('lessonCategoryFilter');
        const items = document.querySelectorAll('.lesson-item');
        const lessonsList = document.getElementById('lessonsList');

        function filterAndSort() {
            const activeBtn = document.querySelector('.lesson-sort-btn.active');
            const sortBy = activeBtn ? activeBtn.dataset.sort : '';
            const category = categoryFilter.value;

            const arr = Array.from(items);
            arr.forEach(item => {
                const matchCategory = !category || item.dataset.category === category;
                item.classList.toggle('d-none', !matchCategory);
            });

            if (sortBy === 'likes') {
                arr.sort((a, b) => parseInt(b.dataset.likes) - parseInt(a.dataset.likes));
            } else if (sortBy === 'recent') {
                arr.sort((a, b) => b.dataset.date.localeCompare(a.dataset.date));
            }
            arr.forEach(item => lessonsList.appendChild(item));
        }

        sortBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                sortBtns.forEach(b => { b.classList.remove('ll-btn-primary', 'active'); b.classList.add('ll-btn-outline'); });
                this.classList.remove('ll-btn-outline');
                this.classList.add('ll-btn-primary', 'active');
                filterAndSort();
            });
        });
        categoryFilter.addEventListener('change', filterAndSort);

        // Like buttons
        document.querySelectorAll('.like-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.id;
                const btnEl = this;
                
                // Show loading state or optimistic update could act here
                // For now, let's just fetch
                fetch('@Url.Action("LikeLesson", "Home")?id=' + id, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            btnEl.innerHTML = '<i class="bi bi-hand-thumbs-up-fill"></i> ' + data.likes;
                            btnEl.classList.add('liked', 'll-btn-primary');
                            btnEl.classList.remove('ll-btn-outline');
                            
                            // Optional: Show toast
                            // var toastEl = document.getElementById('lessonToast');
                            // var toastBody = toastEl.querySelector('.toast-body');
                            // toastBody.textContent = "You liked this lesson!";
                            // var toast = new bootstrap.Toast(toastEl);
                            // toast.show();
                        }
                    });
            });
        });

        // Edit Modal Population
        var editModal = document.getElementById('editLessonModal');
        if (editModal) {
            editModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                if (!button && event.detail.relatedTarget) button = event.detail.relatedTarget; // Fallback
                
                // If triggered via JS manually, might need to handle differently, but here we use buttons
                // Wait, buttons don't have data-bs-toggle="modal" to avoid conflict if we want to do logic first
                // Let's add click listeners to buttons instead of relying on data-bs attributes for data transfer efficiency
            });
        }

        document.querySelectorAll('.edit-lesson-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.getElementById('editLessonId').value = this.dataset.id;
                document.getElementById('editLessonTitle').value = this.dataset.title;
                document.getElementById('editLessonContent').value = this.dataset.content;
                document.getElementById('editLessonCategory').value = this.dataset.category;
                document.getElementById('editLessonTags').value = this.dataset.tags;
                new bootstrap.Modal(document.getElementById('editLessonModal')).show();
            });
        });

        document.querySelectorAll('.delete-lesson-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.getElementById('deleteLessonId').value = this.dataset.id;
                new bootstrap.Modal(document.getElementById('deleteLessonModal')).show();
            });
        });

        // Server-side toast trigger
        @if (TempData["SuccessMessage"] != null)
        {
            <text>
            var toast = new bootstrap.Toast(document.getElementById('lessonToast'));
            toast.show();
            </text>
        }
    })();
</script>
}
