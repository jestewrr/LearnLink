@{
    ViewData["Title"] = "Lessons Learned";
    ViewData["ActivePage"] = "LessonsLearned";

    var lessons = ViewBag.Lessons as List<LearnLink.Models.LessonViewModel> ?? new List<LearnLink.Models.LessonViewModel>();
    var totalLessons = (int)(ViewBag.TotalLessons ?? 0);
    var totalContributors = (int)(ViewBag.TotalContributors ?? 0);
    var totalCategories = (int)(ViewBag.TotalCategories ?? 0);

    string[] iconGradients = {
        "background: linear-gradient(135deg, #fef3c7, #fbbf24)",
        "background: linear-gradient(135deg, #d1fae5, #10b981)",
        "background: linear-gradient(135deg, #dbeafe, #3b82f6)",
        "background: linear-gradient(135deg, #fce7f3, #ec4899)",
        "background: linear-gradient(135deg, #e0e7ff, #6366f1)"
    };
    string[] iconColors = { "text-warning", "text-success", "text-primary", "text-danger", "text-info" };
}

<!-- Page Header -->
<div class="ll-page-header">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
        <div>
            <h1 class="ll-page-title">Lessons Learned</h1>
            <div class="ll-breadcrumb">
                <a href="@Url.Action("Dashboard", "Home")">Home</a>
                <i class="bi bi-chevron-right small"></i>
                <span>Lessons Learned</span>
            </div>
        </div>
        <div class="d-flex gap-2">
            <button class="ll-btn ll-btn-primary" data-bs-toggle="modal" data-bs-target="#submitLessonModal">
                <i class="bi bi-plus-circle"></i>
                Submit Lesson Learned
            </button>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Main Content -->
    <div class="col-lg-8">
        <!-- Filter Tabs -->
        <div class="ll-card mb-4">
            <div class="ll-card-body py-2">
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    <button class="ll-btn ll-btn-primary ll-btn-sm lesson-sort-btn active" data-sort="">All Lessons</button>
                    <button class="ll-btn ll-btn-outline ll-btn-sm lesson-sort-btn" data-sort="likes">Top Rated</button>
                    <button class="ll-btn ll-btn-outline ll-btn-sm lesson-sort-btn" data-sort="recent">Recent</button>
                    <div class="ms-auto">
                        <select class="ll-form-control ll-form-select" style="width: auto;" id="lessonCategoryFilter">
                            <option value="">All Categories</option>
                            @foreach (var category in lessons.Select(l => l.Category).Distinct())
                            {
                            <option>@category</option>
                            }
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lessons List -->
        <div id="lessonsList">
        @for (int i = 0; i < lessons.Count; i++)
        {
            var lesson = lessons[i];
            var gradientIndex = i % iconGradients.Length;
        <div class="d-flex gap-3 border-bottom pb-4 mb-4 lesson-item" data-category="@lesson.Category" data-likes="@lesson.LikeCount" data-date="@lesson.CreatedAt.ToString("yyyy-MM-dd")">
            <div class="ll-discussion-avatar" style="width: 48px; height: 48px; font-size: 1.2rem; flex-shrink: 0; @(string.IsNullOrEmpty(lesson.AuthorColor) ? "" : lesson.AuthorColor)">
                @lesson.AuthorInitials
            </div>
            
            <div class="flex-fill">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <div>
                        <span class="fw-bold fs-6">@lesson.Author</span>
                        <span class="small text-muted ms-2">â€¢ @((DateTime.Now - lesson.CreatedAt).Days) days ago</span>
                    </div>
                    <div class="d-inline-flex gap-2 align-items-center text-muted">
                        @if (ViewBag.CurrentUserId != null && ViewBag.CurrentUserId == lesson.UserId || User.IsInRole("SuperAdmin") || User.IsInRole("Manager")) 
                        {
                            <a href="#" class="btn btn-sm btn-link text-muted p-0 edit-lesson-btn" title="Edit"
                                        data-id="@lesson.Id" 
                                        data-title="@lesson.Title" 
                                        data-content="@lesson.Content" 
                                        data-category="@lesson.Category" 
                                        data-resource-id="@lesson.ResourceId"
                                        data-tags="@string.Join(", ", lesson.Tags)">
                                    <i class="bi bi-pencil fs-6"></i>
                            </a>
                            <a href="#" class="btn btn-sm btn-link text-danger p-0 delete-lesson-btn ms-1" title="Delete" data-id="@lesson.Id">
                                    <i class="bi bi-trash fs-6"></i>
                            </a>
                        }
                    </div>
                </div>
                
                <div class="p-3 mt-2 mb-3 bg-light rounded-3 shadow-sm border">
                    <h6 class="fw-bold mb-2">
                        <i class="bi bi-lightbulb-fill text-warning me-2 fs-5 align-middle"></i>@lesson.Title
                    </h6>
                    <div class="small mb-2"><span class="text-muted">Learned from:</span> <a href="@Url.Action("ResourceDetail", "Home", new { id = lesson.ResourceId })" class="text-decoration-none fw-medium" style="color: var(--ll-primary);">@lesson.ResourceTitle</a></div>
                    <div class="small text-muted mb-3"><i class="bi bi-tag text-muted"></i> @lesson.Category</div>
                    <p class="text-dark mb-0 fs-6" style="white-space: pre-wrap;">@lesson.Content</p>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mt-1">
                    <div class="d-flex flex-wrap gap-2">
                        @foreach (var tag in lesson.Tags)
                        {
                        <span class="ll-tag">@tag</span>
                        }
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-sm btn-white border shadow-sm like-btn" data-id="@lesson.Id">
                            <i class="bi @(lesson.LikeCount > 0 ? "bi-hand-thumbs-up-fill text-primary" : "bi-hand-thumbs-up")"></i> <span class="fw-medium ms-1">@lesson.LikeCount</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        }
        </div>

        <!-- Pagination -->
        <nav aria-label="Lessons pagination" class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item disabled"><a class="page-link" href="#"><i class="bi bi-chevron-left"></i></a></li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#"><i class="bi bi-chevron-right"></i></a></li>
            </ul>
        </nav>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Stats -->
        <div class="ll-card mb-4">
            <div class="ll-card-header">
                <h5 class="ll-card-title">Contribution Stats</h5>
            </div>
            <div class="ll-card-body">
                <div class="row g-3 text-center">
                    <div class="col-6">
                        <div class="p-3 bg-light rounded">
                            <div class="fs-4 fw-bold text-primary">@totalLessons</div>
                            <div class="small text-muted">Total Lessons</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 bg-light rounded">
                            <div class="fs-4 fw-bold text-success">@lessons.Sum(l => l.LikeCount)</div>
                            <div class="small text-muted">Total Likes</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 bg-light rounded">
                            <div class="fs-4 fw-bold text-warning">@totalContributors</div>
                            <div class="small text-muted">Contributors</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 bg-light rounded">
                            <div class="fs-4 fw-bold text-info">@totalCategories</div>
                            <div class="small text-muted">Categories</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Submit Lesson Modal -->
<div class="modal fade" id="submitLessonModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form asp-action="SubmitLesson" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Submit a Lesson Learned</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="ll-form-group">
                        <label class="ll-form-label">Category</label>
                        <select class="ll-form-control ll-form-select" name="Category" required>
                            <option value="">Select a category</option>
                            <option>Teaching Strategies</option>
                            <option>Technology Integration</option>
                            <option>Reading Skills</option>
                            <option>Classroom Management</option>
                            <option>Assessment</option>
                        </select>
                    </div>
                    <div class="ll-form-group position-relative">
                        <label class="ll-form-label">Related Resource</label>
                        <input type="hidden" name="ResourceId" id="submitLessonResourceId" required>
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                            <input type="text" class="form-control border-start-0" id="resourceSearchInput" placeholder="Search and select a resource..." autocomplete="off">
                        </div>
                        <div class="list-group position-absolute w-100 d-none shadow-sm" id="resourceDropdown" style="z-index: 1055; max-height: 250px; overflow-y: auto; top: 100%;">
                            @if (ViewBag.AvailableResources != null)
                            {
                                foreach (var res in (IEnumerable<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>)ViewBag.AvailableResources)
                                {
                                    <button type="button" class="list-group-item list-group-item-action resource-option d-flex align-items-center text-start py-2 px-3 border-0 border-bottom" data-value="@res.Value" data-text="@res.Text">
                                        <i class="bi bi-file-earmark-text me-2 fs-5" style="color: var(--ll-primary);"></i>
                                        <span class="text-truncate">@res.Text</span>
                                    </button>
                                }
                            }
                            <div class="list-group-item text-muted small d-none" id="resourceNoResults">No matching resources found.</div>
                        </div>
                    </div>
                    <div class="ll-form-group">
                        <label class="ll-form-label">Title</label>
                        <input type="text" class="ll-form-control" name="Title" placeholder="Give your lesson a clear title" required>
                    </div>
                    <div class="ll-form-group">
                        <label class="ll-form-label">Your Insight</label>
                        <textarea class="ll-form-control" rows="5" name="Content" placeholder="Share what you learned, what worked well, any tips for others..." required></textarea>
                    </div>
                    <div class="ll-form-group">
                        <label class="ll-form-label">Tags</label>
                        <input type="text" class="ll-form-control" name="Tags" placeholder="Add tags separated by commas" value="General">
                        
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="ll-btn ll-btn-outline" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="ll-btn ll-btn-primary">
                        <i class="bi bi-send"></i>
                        Submit Lesson
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Lesson Modal -->
<div class="modal fade" id="editLessonModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form asp-action="EditLesson" method="post">
                <input type="hidden" name="id" id="editLessonId">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Lesson</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="ll-form-group">
                        <label class="ll-form-label">Category</label>
                        <select class="ll-form-control ll-form-select" name="Category" id="editLessonCategory" required>
                            <option value="">Select a category</option>
                            <option>Teaching Strategies</option>
                            <option>Technology Integration</option>
                            <option>Reading Skills</option>
                            <option>Classroom Management</option>
                            <option>Assessment</option>
                        </select>
                    </div>
                    <div class="ll-form-group position-relative">
                        <label class="ll-form-label">Related Resource</label>
                        <input type="hidden" name="ResourceId" id="editLessonResourceId" required>
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                            <input type="text" class="form-control border-start-0" id="editResourceSearchInput" placeholder="Search and select a resource..." autocomplete="off">
                        </div>
                        <div class="list-group position-absolute w-100 d-none shadow-sm" id="editResourceDropdown" style="z-index: 1055; max-height: 250px; overflow-y: auto; top: 100%;">
                            @if (ViewBag.AvailableResources != null)
                            {
                                foreach (var res in (IEnumerable<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>)ViewBag.AvailableResources)
                                {
                                    <button type="button" class="list-group-item list-group-item-action edit-resource-option d-flex align-items-center text-start py-2 px-3 border-0 border-bottom" data-value="@res.Value" data-text="@res.Text">
                                        <i class="bi bi-file-earmark-text me-2 fs-5" style="color: var(--ll-primary);"></i>
                                        <span class="text-truncate">@res.Text</span>
                                    </button>
                                }
                            }
                            <div class="list-group-item text-muted small d-none" id="editResourceNoResults">No matching resources found.</div>
                        </div>
                    </div>
                    <div class="ll-form-group">
                        <label class="ll-form-label">Title</label>
                        <input type="text" class="ll-form-control" name="Title" id="editLessonTitle" required>
                    </div>
                    <div class="ll-form-group">
                        <label class="ll-form-label">Your Insight</label>
                        <textarea class="ll-form-control" rows="5" name="Content" id="editLessonContent" required></textarea>
                    </div>
                    <div class="ll-form-group">
                        <label class="ll-form-label">Tags</label>
                        <input type="text" class="ll-form-control" name="Tags" id="editLessonTags">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="ll-btn ll-btn-outline" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="ll-btn ll-btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Lesson Modal -->
<div class="modal fade" id="deleteLessonModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form asp-action="DeleteLesson" method="post">
                <input type="hidden" name="id" id="deleteLessonId">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title">Delete Lesson?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Are you sure you want to delete this lesson? This action cannot be undone.</p>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="ll-btn ll-btn-outline" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="ll-btn ll-btn-danger">Delete Lesson</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080;">
    <div id="lessonToast" class="toast" role="alert">
        <div class="toast-header bg-success text-white">
            <i class="bi bi-check-circle me-2"></i>
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">@TempData["SuccessMessage"]</div>
    </div>
</div>

@section Scripts {
<script>
    (function() {
        const sortBtns = document.querySelectorAll('.lesson-sort-btn');
        const categoryFilter = document.getElementById('lessonCategoryFilter');
        const items = document.querySelectorAll('.lesson-item');
        const lessonsList = document.getElementById('lessonsList');

        function filterAndSort() {
            const activeBtn = document.querySelector('.lesson-sort-btn.active');
            const sortBy = activeBtn ? activeBtn.dataset.sort : '';
            const category = categoryFilter.value;

            const arr = Array.from(items);
            arr.forEach(item => {
                const matchCategory = !category || item.dataset.category === category;
                item.classList.toggle('d-none', !matchCategory);
            });

            if (sortBy === 'likes') {
                arr.sort((a, b) => parseInt(b.dataset.likes) - parseInt(a.dataset.likes));
            } else if (sortBy === 'recent') {
                arr.sort((a, b) => b.dataset.date.localeCompare(a.dataset.date));
            }
            arr.forEach(item => lessonsList.appendChild(item));
        }

        sortBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                sortBtns.forEach(b => { b.classList.remove('ll-btn-primary', 'active'); b.classList.add('ll-btn-outline'); });
                this.classList.remove('ll-btn-outline');
                this.classList.add('ll-btn-primary', 'active');
                filterAndSort();
            });
        });
        categoryFilter.addEventListener('change', filterAndSort);

        // Like buttons
        document.querySelectorAll('.like-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.id;
                const btnEl = this;
                
                // Show loading state or optimistic update could act here
                // For now, let's just fetch
                fetch('@Url.Action("LikeLesson", "Home")?id=' + id, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            btnEl.innerHTML = '<i class="bi bi-hand-thumbs-up-fill"></i> ' + data.likes;
                            btnEl.classList.add('liked', 'll-btn-primary');
                            btnEl.classList.remove('ll-btn-outline');
                            
                            // Optional: Show toast
                            // var toastEl = document.getElementById('lessonToast');
                            // var toastBody = toastEl.querySelector('.toast-body');
                            // toastBody.textContent = "You liked this lesson!";
                            // var toast = new bootstrap.Toast(toastEl);
                            // toast.show();
                        }
                    });
            });
        });

        // Edit Modal Population
        var editModal = document.getElementById('editLessonModal');
        if (editModal) {
            editModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                if (!button && event.detail.relatedTarget) button = event.detail.relatedTarget; // Fallback
                
                // If triggered via JS manually, might need to handle differently, but here we use buttons
                // Wait, buttons don't have data-bs-toggle="modal" to avoid conflict if we want to do logic first
                // Let's add click listeners to buttons instead of relying on data-bs attributes for data transfer efficiency
            });
        }

        document.querySelectorAll('.edit-lesson-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.getElementById('editLessonId').value = this.dataset.id;
                document.getElementById('editLessonTitle').value = this.dataset.title;
                document.getElementById('editLessonContent').value = this.dataset.content;
                document.getElementById('editLessonCategory').value = this.dataset.category;
                
                const resourceId = this.dataset.resourceId;
                document.getElementById('editLessonResourceId').value = resourceId;
                let resourceText = "";
                document.querySelectorAll('.edit-resource-option').forEach(opt => {
                    if (opt.dataset.value === resourceId) resourceText = opt.dataset.text;
                });
                document.getElementById('editResourceSearchInput').value = resourceText;
                
                document.getElementById('editLessonTags').value = this.dataset.tags;
                new bootstrap.Modal(document.getElementById('editLessonModal')).show();
            });
        });

        // Autocomplete JS
        function setupSearchDropdown(inputId, hiddenId, dropdownId, optionClass, noResultsId) {
            const input = document.getElementById(inputId);
            const hidden = document.getElementById(hiddenId);
            const dropdown = document.getElementById(dropdownId);
            const options = document.querySelectorAll(optionClass);
            const noResults = document.getElementById(noResultsId);

            if (!input || !dropdown) return;

            input.addEventListener('input', function() {
                const term = this.value.toLowerCase();
                let hasVisible = false;

                options.forEach(opt => {
                    if (opt.dataset.text.toLowerCase().includes(term)) {
                        opt.classList.remove('d-none');
                        hasVisible = true;
                    } else {
                        opt.classList.add('d-none');
                    }
                });

                if (!hasVisible) {
                    noResults.classList.remove('d-none');
                } else {
                    noResults.classList.add('d-none');
                }

                if (term === '') {
                    hidden.value = '';
                }

                dropdown.classList.remove('d-none');
            });

            input.addEventListener('focus', function() {
                const term = this.value.toLowerCase();
                let hasVisible = false;
                options.forEach(opt => {
                    if (opt.dataset.text.toLowerCase().includes(term)) {
                        opt.classList.remove('d-none');
                        hasVisible = true;
                    } else {
                        opt.classList.add('d-none');
                    }
                });
                
                if (!hasVisible && term !== '') {
                    noResults.classList.remove('d-none');
                } else {
                    noResults.classList.add('d-none');
                }
                dropdown.classList.remove('d-none');
            });

            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.add('d-none');
                }
            });

            options.forEach(opt => {
                opt.addEventListener('click', function() {
                    input.value = this.dataset.text;
                    hidden.value = this.dataset.value;
                    dropdown.classList.add('d-none');
                });
            });
            
            // Validate form on submit
            const form = input.closest('form');
            if(form) {
                form.addEventListener('submit', function(e) {
                    if(!hidden.value) {
                        e.preventDefault();
                        input.classList.add('is-invalid');
                        input.focus();
                    } else {
                        input.classList.remove('is-invalid');
                    }
                });
            }
        }

        setupSearchDropdown('resourceSearchInput', 'submitLessonResourceId', 'resourceDropdown', '.resource-option', 'resourceNoResults');
        setupSearchDropdown('editResourceSearchInput', 'editLessonResourceId', 'editResourceDropdown', '.edit-resource-option', 'editResourceNoResults');

        document.querySelectorAll('.delete-lesson-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.getElementById('deleteLessonId').value = this.dataset.id;
                new bootstrap.Modal(document.getElementById('deleteLessonModal')).show();
            });
        });

        // Server-side toast trigger
        var hasSuccess = '@(TempData["SuccessMessage"] != null ? "true" : "false")' === 'true';
        if (hasSuccess) {
            var toast = new bootstrap.Toast(document.getElementById('lessonToast'));
            toast.show();
        }

    })();
</script>
}
