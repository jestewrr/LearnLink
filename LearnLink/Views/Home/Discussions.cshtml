@{
    ViewData["Title"] = "Discussions";
    ViewData["ActivePage"] = "Discussions";

    var discussion = ViewBag.Discussion as LearnLink.Models.DiscussionViewModel;
    var replies = ViewBag.Replies as List<LearnLink.Models.ReplyViewModel> ?? new List<LearnLink.Models.ReplyViewModel>();
    var similarDiscussions = ViewBag.SimilarDiscussions as List<LearnLink.Models.DiscussionViewModel> ?? new List<LearnLink.Models.DiscussionViewModel>();
}

<!-- Page Header -->
<div class="ll-page-header">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
        <div>
            <h1 class="ll-page-title">Discussions</h1>
            <div class="ll-breadcrumb">
                <a href="@Url.Action("Dashboard", "Home")">Home</a>
                <i class="bi bi-chevron-right small"></i>
                <a href="@Url.Action("KnowledgePortal", "Home")">Knowledge Sharing</a>
                <i class="bi bi-chevron-right small"></i>
                <span>Discussions</span>
            </div>
        </div>
    </div>
</div>

<!-- Discussion Thread -->
<div class="row g-4">
    <div class="col-lg-8">
        @if (discussion != null)
        {
        <!-- Main Discussion -->
        <div class="ll-card mb-4">
            <div class="ll-card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    @{
                        var typeClass = discussion.Type switch
                        {
                            "Question" => "ll-badge-info",
                            "Idea" => "ll-badge-info",
                            "Resource" => "ll-badge-success",
                            "Study Group" => "ll-badge-warning",
                            _ => "ll-badge-info"
                        };
                    }
                    <span class="ll-badge @typeClass">@discussion.Type</span>
                    <div class="d-flex gap-2">
                        <button class="ll-btn ll-btn-outline ll-btn-sm" id="bookmarkDiscBtn"><i class="bi bi-bookmark"></i></button>
                        <button class="ll-btn ll-btn-outline ll-btn-sm"><i class="bi bi-share"></i></button>
                    </div>
                </div>

                <h4 class="fw-bold mb-3">@discussion.Title</h4>

                <div class="d-flex gap-3 mb-4">
                    <div class="ll-discussion-avatar" style="width: 48px; height: 48px; @(discussion.AuthorColor ?? "")">@discussion.AuthorInitials</div>
                    <div>
                        <div class="fw-bold">@discussion.Author</div>
                        <div class="small text-muted">@discussion.AuthorRole • Posted @((DateTime.Now - discussion.CreatedAt).TotalHours switch { < 1 => "just now", < 24 => (int)((DateTime.Now - discussion.CreatedAt).TotalHours) + " hours ago", _ => (int)((DateTime.Now - discussion.CreatedAt).TotalDays) + " days ago" })</div>
                    </div>
                </div>

                <div class="mb-4">
                    @Html.Raw(discussion.Content)
                </div>

                <div class="d-flex flex-wrap gap-2 mb-4">
                    @foreach (var tag in discussion.Tags)
                    {
                    <span class="ll-tag">@tag</span>
                    }
                </div>

                <div class="d-flex justify-content-between align-items-center border-top pt-3">
                    <div class="d-flex gap-3">
                        <button class="ll-btn ll-btn-outline ll-btn-sm disc-like-btn">
                            <i class="bi bi-heart"></i> @discussion.LikeCount
                        </button>
                        <span class="small text-muted d-flex align-items-center gap-1">
                            <i class="bi bi-eye"></i> @discussion.ViewCount views
                        </span>
                    </div>
                    <button class="ll-btn ll-btn-primary ll-btn-sm" onclick="document.getElementById('replyTextarea').focus();">
                        <i class="bi bi-reply"></i> Reply
                    </button>
                </div>
            </div>
        </div>
        }

        <!-- Replies -->
        <h6 class="fw-bold text-muted mb-3">@replies.Count Replies</h6>

        @foreach (var reply in replies)
        {
        <div class="ll-card mb-3" @(reply.IsBestAnswer ? "style=\"border: 2px solid #22c55e;\"" : "")>
            @if (reply.IsBestAnswer)
            {
            <div class="ll-card-header bg-success bg-opacity-10">
                <span class="fw-bold text-success"><i class="bi bi-check-circle-fill me-2"></i>Best Answer</span>
            </div>
            }
            <div class="ll-card-body">
                <div class="d-flex gap-3 mb-3">
                    <div class="ll-discussion-avatar" style="width: 40px; height: 40px; @(reply.AuthorColor ?? "")">@reply.AuthorInitials</div>
                    <div class="flex-fill">
                        <div class="d-flex justify-content-between">
                            <div>
                                <span class="fw-bold">@reply.Author</span>
                                @{
                                    var roleClass = reply.AuthorRole switch
                                    {
                                        "Moderator" => "ll-badge-danger",
                                        "Contributor" => "ll-badge-warning",
                                        _ => "ll-badge-info"
                                    };
                                }
                                <span class="ll-badge @roleClass ms-2" style="font-size: 0.65rem;">@reply.AuthorRole</span>
                            </div>
                            <span class="small text-muted">@((DateTime.Now - reply.CreatedAt).TotalMinutes switch { < 60 => (int)((DateTime.Now - reply.CreatedAt).TotalMinutes) + " minutes ago", < 1440 => (int)((DateTime.Now - reply.CreatedAt).TotalHours) + " hours ago", _ => (int)((DateTime.Now - reply.CreatedAt).TotalDays) + " days ago" })</span>
                        </div>
                        <div class="small text-muted">@reply.AuthorTitle</div>
                    </div>
                </div>
                @Html.Raw(reply.Content)
                <div class="d-flex gap-2 mt-3">
                    <button class="ll-btn ll-btn-outline ll-btn-sm reply-like-btn">
                        <i class="bi @(reply.IsLiked ? "bi-heart-fill text-danger" : "bi-heart")"></i> @reply.LikeCount
                    </button>
                    <button class="ll-btn ll-btn-outline ll-btn-sm"><i class="bi bi-reply"></i> Reply</button>
                </div>
            </div>
        </div>
        }

        <!-- Add Reply Box -->
        <div class="ll-card">
            <div class="ll-card-body">
                <h6 class="fw-bold mb-3">Add Your Reply</h6>
                <textarea class="ll-form-control mb-3" rows="4" id="replyTextarea" placeholder="Share your thoughts, experiences, or tips..."></textarea>
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex gap-2">
                        <button class="ll-btn ll-btn-outline ll-btn-sm" title="Add link"><i class="bi bi-link-45deg"></i></button>
                        <button class="ll-btn ll-btn-outline ll-btn-sm" title="Add image"><i class="bi bi-image"></i></button>
                        <button class="ll-btn ll-btn-outline ll-btn-sm" title="Add code"><i class="bi bi-code"></i></button>
                    </div>
                    <button class="ll-btn ll-btn-primary" id="postReplyBtn">
                        <i class="bi bi-send"></i> Post Reply
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Similar Discussions -->
        <div class="ll-card">
            <div class="ll-card-header">
                <h5 class="ll-card-title">Similar Discussions</h5>
            </div>
            <div class="ll-card-body">
                @for (int i = 0; i < similarDiscussions.Count; i++)
                {
                    var sim = similarDiscussions[i];
                <a href="#" class="d-block text-decoration-none text-dark mb-3 pb-3 @(i < similarDiscussions.Count - 1 ? "border-bottom" : "")">
                    <div class="fw-medium small">@sim.Title</div>
                    <div class="small text-muted">@sim.ReplyCount replies • @((DateTime.Now - sim.CreatedAt).Days switch { 0 => "Today", 1 => "Yesterday", var d when d < 7 => d + " days ago", var d when d < 30 => (d / 7) + " weeks ago", _ => sim.CreatedAt.ToString("MMM dd") })</div>
                </a>
                }
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080;">
    <div id="discToast" class="toast" role="alert">
        <div class="toast-header bg-success text-white">
            <i class="bi bi-check-circle me-2"></i>
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">Your reply has been posted successfully!</div>
    </div>
</div>

@section Scripts {
<script>
    (function() {
        // Like buttons
        document.querySelectorAll('.disc-like-btn, .reply-like-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const icon = this.querySelector('i');
                const isLiked = icon.classList.contains('bi-heart-fill');
                const countText = this.textContent.trim();
                const count = parseInt(countText.match(/\d+/)?.[0] || '0');
                if (isLiked) {
                    icon.classList.remove('bi-heart-fill', 'text-danger');
                    icon.classList.add('bi-heart');
                    this.innerHTML = `<i class="${icon.className}"></i> ${count - 1}`;
                } else {
                    icon.classList.remove('bi-heart');
                    icon.classList.add('bi-heart-fill', 'text-danger');
                    this.innerHTML = `<i class="bi bi-heart-fill text-danger"></i> ${count + 1}`;
                }
            });
        });

        // Bookmark toggle
        var bookmarkBtn = document.getElementById('bookmarkDiscBtn');
        if (bookmarkBtn) {
            bookmarkBtn.addEventListener('click', function() {
                var icon = this.querySelector('i');
                icon.classList.toggle('bi-bookmark');
                icon.classList.toggle('bi-bookmark-fill');
                icon.classList.toggle('text-warning');
            });
        }

        // Post reply
        document.getElementById('postReplyBtn').addEventListener('click', function() {
            const textarea = document.getElementById('replyTextarea');
            if (!textarea.value.trim()) { alert('Please enter your reply.'); return; }
            textarea.value = '';
            var toast = new bootstrap.Toast(document.getElementById('discToast'));
            toast.show();
        });
    })();
</script>
}
