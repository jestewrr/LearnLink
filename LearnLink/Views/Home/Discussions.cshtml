@{
    ViewData["Title"] = "Discussions";
    ViewData["ActivePage"] = "Discussions";

    var discussion = ViewBag.Discussion as LearnLink.Models.DiscussionViewModel;
    var replies = ViewBag.Replies as List<LearnLink.Models.ReplyViewModel> ?? new List<LearnLink.Models.ReplyViewModel>();
    var similarDiscussions = ViewBag.SimilarDiscussions as List<LearnLink.Models.DiscussionViewModel> ?? new List<LearnLink.Models.DiscussionViewModel>();
}

<!-- Page Header -->
<div class="ll-page-header">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
        <div>
            <h1 class="ll-page-title">Discussions</h1>
            <div class="ll-breadcrumb">
                <a href="@Url.Action("Dashboard", "Home")">Home</a>
                <i class="bi bi-chevron-right small"></i>
                <a href="@Url.Action("KnowledgePortal", "Home")">Knowledge Sharing</a>
                <i class="bi bi-chevron-right small"></i>
                <span>Discussions</span>
            </div>
        </div>
    </div>
</div>

<!-- Discussion Thread -->
<div class="row g-4">
    <div class="col-lg-8">
        @if (discussion != null)
        {
        <!-- Main Discussion -->
        <div class="ll-card mb-4">
            <div class="ll-card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    @{
                        var typeClass = discussion.Type switch
                        {
                            "Question" => "ll-badge-info",
                            "Idea" => "ll-badge-info",
                            "Resource" => "ll-badge-success",
                            "Study Group" => "ll-badge-warning",
                            _ => "ll-badge-info"
                        };
                    }
                    <span class="ll-badge @typeClass">@discussion.Type</span>
                    <div class="d-flex gap-2">
                        <button class="ll-btn ll-btn-outline ll-btn-sm" id="bookmarkDiscBtn"><i class="bi bi-bookmark"></i></button>
                        <button class="ll-btn ll-btn-outline ll-btn-sm"><i class="bi bi-share"></i></button>
                        @if (User.Identity?.Name == discussion.Author || discussion.Author == "Jester" || discussion.Author == "You")
                        {
                            <div class="dropdown">
                                <button class="ll-btn ll-btn-outline ll-btn-sm" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item edit-disc-btn" href="#" 
                                           data-id="@discussion.Id" 
                                           data-title="@discussion.Title" 
                                           data-content="@discussion.Content" 
                                           data-type="@discussion.Type"><i class="bi bi-pencil me-2"></i>Edit</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger delete-disc-btn" href="#" data-id="@discussion.Id"><i class="bi bi-trash me-2"></i>Delete</a></li>
                                </ul>
                            </div>
                        }
                    </div>
                </div>

                <h4 class="fw-bold mb-3">@discussion.Title</h4>

                <div class="d-flex gap-3 mb-4">
                    <div class="ll-discussion-avatar" style="width: 48px; height: 48px; @(discussion.AuthorColor ?? "")">@discussion.AuthorInitials</div>
                    <div>
                        <div class="fw-bold">@discussion.Author</div>
                        <div class="small text-muted">@discussion.AuthorRole • Posted @((DateTime.Now - discussion.CreatedAt).TotalHours switch { < 1 => "just now", < 24 => (int)((DateTime.Now - discussion.CreatedAt).TotalHours) + " hours ago", _ => (int)((DateTime.Now - discussion.CreatedAt).TotalDays) + " days ago" })</div>
                    </div>
                </div>

                <div class="mb-4">
                    @Html.Raw(discussion.Content)
                </div>

                <div class="d-flex flex-wrap gap-2 mb-4">
                    @foreach (var tag in discussion.Tags)
                    {
                    <span class="ll-tag">@tag</span>
                    }
                </div>

                <div class="d-flex justify-content-between align-items-center border-top pt-3">
                    <div class="d-flex gap-3">
                        <button class="ll-btn ll-btn-outline ll-btn-sm disc-like-btn" data-id="@discussion.Id">
                            <i class="bi bi-heart@(discussion.IsLiked ? "-fill text-danger" : "")"></i> <span class="like-count">@discussion.LikeCount</span>
                        </button>
                        <span class="small text-muted d-flex align-items-center gap-1">
                            <i class="bi bi-eye"></i> @discussion.ViewCount views
                        </span>
                    </div>
                    <button class="ll-btn ll-btn-primary ll-btn-sm" onclick="document.getElementById('replyTextarea').focus();">
                        <i class="bi bi-reply"></i> Reply
                    </button>
                </div>
            </div>
        </div>
        }

        <!-- Replies -->
        <h6 class="fw-bold text-muted mb-3">@replies.Count Replies</h6>

        @foreach (var reply in replies)
        {
        <div class="ll-card mb-3" @(reply.IsBestAnswer ? "style=\"border: 2px solid #22c55e;\"" : "")>
            @if (reply.IsBestAnswer)
            {
            <div class="ll-card-header bg-success bg-opacity-10">
                <span class="fw-bold text-success"><i class="bi bi-check-circle-fill me-2"></i>Best Answer</span>
            </div>
            }
            <div class="ll-card-body">
                <div class="d-flex gap-3 mb-3">
                    <div class="ll-discussion-avatar" style="width: 40px; height: 40px; @(reply.AuthorColor ?? "")">@reply.AuthorInitials</div>
                    <div class="flex-fill">
                        <div class="d-flex justify-content-between">
                            <div>
                                <span class="fw-bold">@reply.Author</span>
                                @{
                                    var roleClass = reply.AuthorRole switch
                                    {
                                        "Moderator" => "ll-badge-danger",
                                        "Contributor" => "ll-badge-warning",
                                        _ => "ll-badge-info"
                                    };
                                }
                                <span class="ll-badge @roleClass ms-2" style="font-size: 0.65rem;">@reply.AuthorRole</span>
                            </div>
                            <span class="small text-muted">@((DateTime.Now - reply.CreatedAt).TotalMinutes switch { < 60 => (int)((DateTime.Now - reply.CreatedAt).TotalMinutes) + " minutes ago", < 1440 => (int)((DateTime.Now - reply.CreatedAt).TotalHours) + " hours ago", _ => (int)((DateTime.Now - reply.CreatedAt).TotalDays) + " days ago" })</span>
                        </div>
                        <div class="small text-muted">@reply.AuthorTitle</div>
                    </div>
                </div>
                @Html.Raw(reply.Content)
                <div class="d-flex gap-2 mt-3">
                    <button class="ll-btn ll-btn-outline ll-btn-sm reply-like-btn" data-id="@reply.Id">
                        <i class="bi @(reply.IsLiked ? "bi-heart-fill text-danger" : "bi-heart")"></i> <span class="like-count">@reply.LikeCount</span>
                    </button>
                    <button class="ll-btn ll-btn-outline ll-btn-sm"><i class="bi bi-reply"></i> Reply</button>
                    @if (User.Identity?.Name == reply.Author || reply.Author == "Jester" || reply.Author == "You")
                    {
                        <button class="ll-btn ll-btn-outline ll-btn-sm text-danger delete-reply-btn" data-id="@reply.Id"><i class="bi bi-trash"></i></button>
                    }
                </div>
            </div>
        </div>
        }

        <!-- Add Reply Box -->
        <div class="ll-card">
            <div class="ll-card-body">
                <h6 class="fw-bold mb-3">Add Your Reply</h6>
                <form asp-action="PostReply" method="post">
                    <input type="hidden" name="discussionId" value="@(discussion?.Id ?? 1)" />
                    <textarea class="ll-form-control mb-3" rows="4" name="content" id="replyTextarea" placeholder="Share your thoughts, experiences, or tips..." required></textarea>
                    <div class="d-flex justify-content-end align-items-center">
                        <button type="submit" class="ll-btn ll-btn-primary">
                            <i class="bi bi-send"></i> Post Reply
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Similar Discussions -->
        <div class="ll-card">
            <div class="ll-card-header">
                <h5 class="ll-card-title">Similar Discussions</h5>
            </div>
            <div class="ll-card-body">
                @for (int i = 0; i < similarDiscussions.Count; i++)
                {
                    var sim = similarDiscussions[i];
                <a href="@Url.Action("Discussions", "Home", new { id = sim.Id })" class="d-block text-decoration-none text-dark mb-3 pb-3 @(i < similarDiscussions.Count - 1 ? "border-bottom" : "")">
                    <div class="fw-medium small">@sim.Title</div>
                    <div class="small text-muted">@sim.ReplyCount replies • @((DateTime.Now - sim.CreatedAt).Days switch { 0 => "Today", 1 => "Yesterday", var d when d < 7 => d + " days ago", var d when d < 30 => (d / 7) + " weeks ago", _ => sim.CreatedAt.ToString("MMM dd") })</div>
                </a>
                }
            </div>
        </div>
    </div>
</div>

<!-- Edit Discussion Modal -->
<div class="modal fade" id="editDiscussionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form asp-action="EditDiscussion" method="post">
                <input type="hidden" name="id" id="editDiscId">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Discussion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="ll-form-group">
                        <label class="ll-form-label">Discussion Type</label>
                        <input type="hidden" name="Type" id="editDiscType">
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="ll-btn ll-btn-outline ll-btn-sm edit-disc-type-btn" data-value="Question">Question</button>
                            <button type="button" class="ll-btn ll-btn-outline ll-btn-sm edit-disc-type-btn" data-value="Idea">Idea</button>
                            <button type="button" class="ll-btn ll-btn-outline ll-btn-sm edit-disc-type-btn" data-value="Resource">Resource</button>
                            <button type="button" class="ll-btn ll-btn-outline ll-btn-sm edit-disc-type-btn" data-value="Study Group">Study Group</button>
                            <button type="button" class="ll-btn ll-btn-outline ll-btn-sm edit-disc-type-btn" data-value="General">General</button>
                        </div>
                    </div>
                    <div class="ll-form-group">
                        <label class="ll-form-label">Title</label>
                        <input type="text" class="ll-form-control" name="Title" id="editDiscTitle" required>
                    </div>
                    <div class="ll-form-group">
                        <label class="ll-form-label">Content</label>
                        <textarea class="ll-form-control" rows="6" name="Content" id="editDiscContent" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="ll-btn ll-btn-outline" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="ll-btn ll-btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Discussion Modal -->
<div class="modal fade" id="deleteDiscussionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form asp-action="DeleteDiscussion" method="post">
                <input type="hidden" name="id" id="deleteDiscId">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title">Delete Discussion?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Are you sure you want to delete this discussion?</p>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="ll-btn ll-btn-outline" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="ll-btn ll-btn-danger">Delete Discussion</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Reply Modal -->
<div class="modal fade" id="deleteReplyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form asp-action="DeleteReply" method="post">
                <input type="hidden" name="id" id="deleteReplyId">
                <input type="hidden" name="discussionId" value="@(discussion?.Id ?? 0)">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title">Delete Reply?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Are you sure you want to delete this reply?</p>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="ll-btn ll-btn-outline" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="ll-btn ll-btn-danger">Delete Reply</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080;">
    <div id="discToast" class="toast" role="alert">
        <div class="toast-header bg-success text-white">
            <i class="bi bi-check-circle me-2"></i>
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">@TempData["SuccessMessage"]</div>
    </div>
</div>

@section Scripts {
<script>
    function insertMarkdown(markdown) {
        var textarea = document.getElementById("replyTextarea");
        if (!textarea) return;
        var start = textarea.selectionStart;
        var end = textarea.selectionEnd;
        var text = textarea.value;
        textarea.value = (text.substring(0, start) + markdown + text.substring(end, text.length));
        textarea.selectionStart = textarea.selectionEnd = start + markdown.length;
        textarea.focus();
    }

    (function() {
        // Like buttons
        document.querySelectorAll('.disc-like-btn, .reply-like-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.id;
                const btnEl = this;
                const isReply = btnEl.classList.contains('reply-like-btn');
                const url = isReply ? '@Url.Action("LikeReply", "Home")' : '@Url.Action("LikeDiscussion", "Home")';
                const icon = btnEl.querySelector('i');
                const countEl = btnEl.querySelector('.like-count');
                
                fetch(url + '?id=' + id, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            if (btnEl.innerHTML.includes('bi-heart-fill')) {    
                                // Actually backend toggles increase only in current mock, let's assume it handles toggle
                                // For visual feedback based on backend response "isLiked"
                                if (data.isLiked) {
                                    icon.classList.remove('bi-heart');
                                    icon.classList.add('bi-heart-fill', 'text-danger');
                                } else {
                                    icon.classList.remove('bi-heart-fill', 'text-danger');
                                    icon.classList.add('bi-heart');
                                }
                            } else {
                                icon.classList.remove('bi-heart');
                                icon.classList.add('bi-heart-fill', 'text-danger');
                            }
                            countEl.textContent = data.likes;
                        }
                    });
            });
        });

        // Edit Discussion type buttons
        document.querySelectorAll('.edit-disc-type-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.edit-disc-type-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                document.getElementById("editDiscType").value = this.dataset.value;
            });
        });

        // Edit/Delete Interactions
        document.querySelectorAll('.edit-disc-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('editDiscId').value = this.dataset.id;
                document.getElementById('editDiscTitle').value = this.dataset.title;
                document.getElementById('editDiscContent').value = this.dataset.content;
                document.getElementById('editDiscType').value = this.dataset.type;
                
                // Set active type button
                document.querySelectorAll('.edit-disc-type-btn').forEach(b => {
                    if (b.dataset.value === this.dataset.type) b.classList.add('active');
                    else b.classList.remove('active');
                });
                
                new bootstrap.Modal(document.getElementById('editDiscussionModal')).show();
            });
        });

        document.querySelectorAll('.delete-disc-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('deleteDiscId').value = this.dataset.id;
                new bootstrap.Modal(document.getElementById('deleteDiscussionModal')).show();
            });
        });

        document.querySelectorAll('.delete-reply-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.getElementById('deleteReplyId').value = this.dataset.id;
                new bootstrap.Modal(document.getElementById('deleteReplyModal')).show();
            });
        });

        // Bookmark toggle
        var bookmarkBtn = document.getElementById('bookmarkDiscBtn');
        if (bookmarkBtn) {
            bookmarkBtn.addEventListener('click', function() {
                var icon = this.querySelector('i');
                icon.classList.toggle('bi-bookmark');
                icon.classList.toggle('bi-bookmark-fill');
                icon.classList.toggle('text-warning');
            });
        }

        // Server-side toast trigger
        var hasSuccess = '@(TempData["SuccessMessage"] != null ? "true" : "false")' === 'true';
        if (hasSuccess) {
            var toast = new bootstrap.Toast(document.getElementById('discToast'));
            toast.show();
        }
    })();
</script>
}
