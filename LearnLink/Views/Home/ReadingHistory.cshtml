@{
    ViewData["Title"] = "Reading History";
    ViewData["ActivePage"] = "ReadingHistory";

    var history = ViewBag.ReadingHistory as List<LearnLink.Models.ReadingHistoryViewModel> ?? new List<LearnLink.Models.ReadingHistoryViewModel>();
    var inProgress = history.Where(h => h.Status == "In Progress").ToList();
    var completed = history.Where(h => h.Status == "Completed").ToList();
    var bookmarked = history.Where(h => h.IsBookmarked).ToList();

    string GetGradient(string format) => format?.ToUpper() switch
    {
        "PDF" => "background: linear-gradient(135deg, #ef4444, #dc2626)",
        "DOCX" => "background: linear-gradient(135deg, #3b82f6, #2563eb)",
        "PPTX" => "background: linear-gradient(135deg, #f59e0b, #d97706)",
        "XLSX" => "background: linear-gradient(135deg, #10b981, #059669)",
        _ => "background: linear-gradient(135deg, #8b5cf6, #7c3aed)"
    };

    string GetIcon(string format) => format?.ToUpper() switch
    {
        "PDF" => "bi-file-earmark-pdf",
        "DOCX" => "bi-file-earmark-word",
        "PPTX" => "bi-file-earmark-ppt",
        "XLSX" => "bi-file-earmark-excel",
        _ => "bi-play-circle"
    };

    string GetProgressColor(int pct) => pct >= 75 ? "primary" : pct >= 50 ? "success" : "warning";
}

<!-- Page Header -->
<div class="ll-page-header">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
        <div>
            <h1 class="ll-page-title">Reading History</h1>
            <div class="ll-breadcrumb">
                <a href="@Url.Action("Dashboard", "Home")">Home</a>
                <i class="bi bi-chevron-right small"></i>
                <span>Reading History</span>
            </div>
        </div>
        <div class="d-flex gap-2">
            <button class="ll-btn ll-btn-outline" id="clearHistoryBtn">
                <i class="bi bi-trash"></i>
                Clear History
            </button>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Main Content -->
    <div class="col-lg-8">
        <!-- Filter Tabs -->
        <div class="ll-card mb-4">
            <div class="ll-card-body py-2">
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    <button class="ll-btn ll-btn-primary ll-btn-sm history-filter-btn active" data-filter="">All (@history.Count)</button>
                    <button class="ll-btn ll-btn-outline ll-btn-sm history-filter-btn" data-filter="in-progress">In Progress (@inProgress.Count)</button>
                    <button class="ll-btn ll-btn-outline ll-btn-sm history-filter-btn" data-filter="completed">Completed (@completed.Count)</button>
                    <button class="ll-btn ll-btn-outline ll-btn-sm history-filter-btn" data-filter="bookmarked">Bookmarked (@bookmarked.Count)</button>
                    <div class="ms-auto">
                        <select class="ll-form-control ll-form-select" style="width: auto;" id="historySortSelect">
                            <option value="recent">Most Recent</option>
                            <option value="oldest">Oldest First</option>
                            <option value="title">A-Z</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        @if (inProgress.Any())
        {
        <!-- Continue Reading Section -->
        <h6 class="fw-bold text-muted mb-3"><i class="bi bi-arrow-clockwise me-2"></i>Continue Reading</h6>

        @foreach (var item in inProgress)
        {
        <div class="ll-card mb-4 history-item" data-filter="in-progress" data-bookmarked="@item.IsBookmarked.ToString().ToLower()" data-title="@item.ResourceTitle.ToLower()" data-date="@item.LastAccessedDate.ToString("yyyy-MM-dd")">
            <div class="ll-card-body">
                <div class="d-flex gap-3 flex-wrap flex-md-nowrap">
                    <div style="width: 80px; height: 100px; @GetGradient(item.ResourceFormat); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                        <i class="bi @GetIcon(item.ResourceFormat) fs-2"></i>
                    </div>
                    <div class="flex-fill">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="fw-bold mb-1">@item.ResourceTitle</h6>
                                <div class="small text-muted">by @item.ResourceAuthor • @item.ResourceSubject • @item.ResourceGrade</div>
                            </div>
                            <button class="ll-btn ll-btn-outline ll-btn-sm ll-btn-icon bookmark-btn">
                                <i class="bi @(item.IsBookmarked ? "bi-bookmark-fill text-warning" : "bi-bookmark")"></i>
                            </button>
                        </div>
                        <p class="text-muted small mb-3">Last read: @item.LastPosition • @((DateTime.Now - item.LastAccessedDate).Days) days ago</p>
                        <div class="d-flex align-items-center gap-3 mb-3">
                            <div class="ll-progress flex-fill" style="height: 8px;">
                                <div class="ll-progress-bar @GetProgressColor(item.ProgressPercent)" style="width: @(item.ProgressPercent)%;"></div>
                            </div>
                            <span class="small fw-medium">@(item.ProgressPercent)%</span>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="#" class="ll-btn ll-btn-primary ll-btn-sm">
                                <i class="bi bi-play-fill"></i>
                                Continue Reading
                            </a>
                            <button class="ll-btn ll-btn-outline ll-btn-sm">
                                <i class="bi bi-arrow-counterclockwise"></i>
                                Start Over
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        }
        }

        @if (completed.Any())
        {
        <!-- Recently Completed -->
        <h6 class="fw-bold text-muted mb-3 mt-4"><i class="bi bi-check-circle me-2"></i>Recently Completed</h6>

        @foreach (var item in completed)
        {
        <div class="ll-card mb-3 history-item" data-filter="completed" data-bookmarked="@item.IsBookmarked.ToString().ToLower()" data-title="@item.ResourceTitle.ToLower()" data-date="@item.LastAccessedDate.ToString("yyyy-MM-dd")">
            <div class="ll-card-body">
                <div class="d-flex gap-3 align-items-center">
                    <div style="width: 56px; height: 56px; background: @item.IconBg; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="bi @item.IconClass @item.IconColor fs-4"></i>
                    </div>
                    <div class="flex-fill">
                        <h6 class="fw-bold mb-1">@item.ResourceTitle</h6>
                        <div class="small text-muted">Completed • @item.CompletedDate?.ToString("MMMM dd, yyyy")</div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="ll-badge ll-badge-success"><i class="bi bi-check-circle me-1"></i>100%</span>
                        <div class="dropdown">
                            <button class="ll-btn ll-btn-outline ll-btn-sm ll-btn-icon" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#"><i class="bi bi-arrow-clockwise me-2"></i>Read Again</a></li>
                                <li><a class="dropdown-item" href="#"><i class="bi bi-lightbulb me-2"></i>Add Lesson Learned</a></li>
                                <li><a class="dropdown-item" href="#"><i class="bi bi-star me-2"></i>Rate Resource</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        }
        }

        <nav aria-label="History pagination" class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item disabled"><a class="page-link" href="#"><i class="bi bi-chevron-left"></i></a></li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#"><i class="bi bi-chevron-right"></i></a></li>
            </ul>
        </nav>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Reading Stats -->
        <div class="ll-card mb-4">
            <div class="ll-card-header">
                <h5 class="ll-card-title">Your Reading Stats</h5>
            </div>
            <div class="ll-card-body">
                <div class="row g-3 text-center mb-4">
                    <div class="col-6">
                        <div class="p-3 bg-light rounded">
                            <div class="fs-3 fw-bold text-primary">@history.Count</div>
                            <div class="small text-muted">Resources Read</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 bg-light rounded">
                            <div class="fs-3 fw-bold text-success">@completed.Count</div>
                            <div class="small text-muted">Completed</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 bg-light rounded">
                            <div class="fs-3 fw-bold text-warning">@inProgress.Count</div>
                            <div class="small text-muted">In Progress</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 bg-light rounded">
                            <div class="fs-3 fw-bold text-info">@bookmarked.Count</div>
                            <div class="small text-muted">Bookmarked</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    (function() {
        const filterBtns = document.querySelectorAll('.history-filter-btn');
        const items = document.querySelectorAll('.history-item');

        filterBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                filterBtns.forEach(b => { b.classList.remove('ll-btn-primary', 'active'); b.classList.add('ll-btn-outline'); });
                this.classList.remove('ll-btn-outline');
                this.classList.add('ll-btn-primary', 'active');
                const filter = this.dataset.filter;
                items.forEach(item => {
                    if (!filter) { item.classList.remove('d-none'); return; }
                    if (filter === 'bookmarked') {
                        item.classList.toggle('d-none', item.dataset.bookmarked !== 'true');
                    } else {
                        item.classList.toggle('d-none', item.dataset.filter !== filter);
                    }
                });
            });
        });

        // Bookmark toggle
        document.querySelectorAll('.bookmark-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const icon = this.querySelector('i');
                icon.classList.toggle('bi-bookmark');
                icon.classList.toggle('bi-bookmark-fill');
                icon.classList.toggle('text-warning');
            });
        });
    })();
</script>
}
