@{
    ViewData["Title"] = "Knowledge Sharing Portal";
    ViewData["ActivePage"] = "KnowledgePortal";

    var discussions = ViewBag.Discussions as List<LearnLink.Models.DiscussionViewModel> ?? new List<LearnLink.Models.DiscussionViewModel>();
}

<!-- Page Header -->
<div class="ll-page-header">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
        <div>
            <h1 class="ll-page-title">Knowledge Sharing Portal</h1>
            <div class="ll-breadcrumb">
                <a href="@Url.Action("Dashboard", "Home")">Home</a>
                <i class="bi bi-chevron-right small"></i>
                <span>Knowledge Sharing Portal</span>
            </div>
        </div>
        <div class="d-flex gap-2">
            <button class="ll-btn ll-btn-primary" data-bs-toggle="modal" data-bs-target="#newDiscussionModal">
                <i class="bi bi-plus-circle"></i>
                Start Discussion
            </button>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Main Content -->
    <div class="col-lg-12">
        <!-- Search -->
        <div class="ll-card mb-4">
            <div class="ll-card-body">
                <div class="position-relative">
                    <i class="bi bi-search position-absolute top-50 translate-middle-y ms-3 text-muted"></i>
                    <input type="text" class="ll-form-control ps-5" id="portalSearchInput" placeholder="Search discussions...">
                </div>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="ll-card mb-4">
            <div class="ll-card-body py-2">
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    <button class="ll-btn ll-btn-primary ll-btn-sm portal-filter-btn active" data-type="">All Discussions</button>
                    <button class="ll-btn ll-btn-outline ll-btn-sm portal-filter-btn" data-type="Question">Questions</button>
                    <button class="ll-btn ll-btn-outline ll-btn-sm portal-filter-btn" data-type="Idea">Ideas</button>
                    <button class="ll-btn ll-btn-outline ll-btn-sm portal-filter-btn" data-type="Resource">Resources</button>
                    <button class="ll-btn ll-btn-outline ll-btn-sm portal-filter-btn" data-type="Study Group">Study Groups</button>
                    <div class="ms-auto">
                        <select class="ll-form-control ll-form-select" style="width: auto;" id="portalSortSelect">
                            <option value="recent">Most Recent</option>
                            <option value="likes">Most Liked</option>
                            <option value="comments">Most Commented</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Discussions List -->
        <div id="portalDiscussionsList">
        @foreach (var discussion in discussions)
        {
            var typeClass = discussion.Type switch
            {
                "Question" => "ll-badge-info",
                "Idea" => "ll-badge-info",
                "Resource" => "ll-badge-success",
                "Study Group" => "ll-badge-warning",
                _ => "ll-badge-info"
            };
        <div class="ll-discussion-card portal-discussion-item" data-type="@discussion.Type" data-likes="@discussion.LikeCount" data-comments="@discussion.ReplyCount" data-date="@discussion.CreatedAt.ToString("yyyy-MM-dd")" data-title="@discussion.Title.ToLower()">
            <div class="ll-discussion-header">
                <div class="ll-discussion-avatar" @(string.IsNullOrEmpty(discussion.AuthorColor) ? "" : $"style=\"{discussion.AuthorColor}\"")>@discussion.AuthorInitials</div>
                <div class="ll-discussion-info">
                    <a href="#" class="ll-discussion-title text-decoration-none">@discussion.Title</a>
                    <div class="ll-discussion-meta">
                        <span class="fw-medium">@discussion.Author</span> • @discussion.AuthorRole • @((DateTime.Now - discussion.CreatedAt).Days switch { 0 => "Today", 1 => "Yesterday", var d => d + " days ago" })
                    </div>
                </div>
                <span class="ll-badge @typeClass">@discussion.Type</span>
            </div>
            <p class="ll-discussion-excerpt">@discussion.Content</p>
            <div class="d-flex flex-wrap gap-2 mb-3">
                @foreach (var tag in discussion.Tags)
                {
                <span class="ll-tag">@tag</span>
                }
            </div>
            <div class="ll-discussion-stats">
                <span><i class="bi bi-heart"></i> @discussion.LikeCount likes</span>
                <span><i class="bi bi-chat"></i> @discussion.ReplyCount comments</span>
                <span><i class="bi bi-eye"></i> @discussion.ViewCount views</span>
            </div>
        </div>
        }
        </div>

        <!-- No Results -->
        <div class="text-center py-5 d-none" id="portalNoResults">
            <i class="bi bi-chat-square-text fs-1 text-muted"></i>
            <h5 class="mt-3">No discussions found</h5>
            <p class="text-muted">Try adjusting your filter.</p>
        </div>

        <!-- Load More -->
        <div class="text-center mt-4">
            <button class="ll-btn ll-btn-outline">
                <i class="bi bi-arrow-clockwise"></i>
                Load More Discussions
            </button>
        </div>
    </div>
</div>

<!-- New Discussion Modal -->
<div class="modal fade" id="newDiscussionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Start a New Discussion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="ll-form-group">
                    <label class="ll-form-label">Discussion Type</label>
                    <div class="d-flex flex-wrap gap-2">
                        <button type="button" class="ll-btn ll-btn-outline ll-btn-sm disc-type-btn active">Question</button>
                        <button type="button" class="ll-btn ll-btn-outline ll-btn-sm disc-type-btn">Idea</button>
                        <button type="button" class="ll-btn ll-btn-outline ll-btn-sm disc-type-btn">Resource Share</button>
                        <button type="button" class="ll-btn ll-btn-outline ll-btn-sm disc-type-btn">Study Group</button>
                        <button type="button" class="ll-btn ll-btn-outline ll-btn-sm disc-type-btn">General</button>
                    </div>
                </div>
                <div class="ll-form-group">
                    <label class="ll-form-label">Title</label>
                    <input type="text" class="ll-form-control" id="discTitle" placeholder="Enter a clear, descriptive title" required>
                </div>
                <div class="ll-form-group">
                    <label class="ll-form-label">Content</label>
                    <textarea class="ll-form-control" rows="6" id="discContent" placeholder="Share your thoughts, questions, or ideas..." required></textarea>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="ll-form-group">
                            <label class="ll-form-label">Subject</label>
                            <select class="ll-form-control ll-form-select">
                                <option value="">Select subject (optional)</option>
                                <option>Mathematics</option>
                                <option>Science</option>
                                <option>English</option>
                                <option>Filipino</option>
                                <option>History</option>
                                <option>MAPEH</option>
                                <option>TLE</option>
                                <option>General</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="ll-form-group">
                            <label class="ll-form-label">Grade Level</label>
                            <select class="ll-form-control ll-form-select">
                                <option value="">Select grade (optional)</option>
                                <option>Grade 7</option>
                                <option>Grade 8</option>
                                <option>Grade 9</option>
                                <option>Grade 10</option>
                                <option>All Grades</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="ll-form-group">
                    <label class="ll-form-label">Tags</label>
                    <input type="text" class="ll-form-control" placeholder="Add tags separated by commas">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="ll-btn ll-btn-outline" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="ll-btn ll-btn-primary" id="postDiscussionBtn">
                    <i class="bi bi-send"></i>
                    Post Discussion
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080;">
    <div id="portalToast" class="toast" role="alert">
        <div class="toast-header bg-success text-white">
            <i class="bi bi-check-circle me-2"></i>
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">Your discussion has been posted successfully!</div>
    </div>
</div>

@section Scripts {
<script>
    (function() {
        const filterBtns = document.querySelectorAll('.portal-filter-btn');
        const items = document.querySelectorAll('.portal-discussion-item');
        const searchInput = document.getElementById('portalSearchInput');
        const sortSelect = document.getElementById('portalSortSelect');
        const list = document.getElementById('portalDiscussionsList');
        const noResults = document.getElementById('portalNoResults');

        function filterAndSort() {
            const activeBtn = document.querySelector('.portal-filter-btn.active');
            const typeFilter = activeBtn ? activeBtn.dataset.type : '';
            const query = searchInput.value.toLowerCase();
            let visibleCount = 0;

            const arr = Array.from(items);
            arr.forEach(item => {
                const matchType = !typeFilter || item.dataset.type === typeFilter;
                const matchSearch = !query || item.dataset.title.includes(query);
                const visible = matchType && matchSearch;
                item.classList.toggle('d-none', !visible);
                if (visible) visibleCount++;
            });

            // Sort
            arr.sort((a, b) => {
                switch (sortSelect.value) {
                    case 'likes': return parseInt(b.dataset.likes) - parseInt(a.dataset.likes);
                    case 'comments': return parseInt(b.dataset.comments) - parseInt(a.dataset.comments);
                    default: return b.dataset.date.localeCompare(a.dataset.date);
                }
            });
            arr.forEach(item => list.appendChild(item));
            noResults.classList.toggle('d-none', visibleCount > 0);
        }

        filterBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                filterBtns.forEach(b => { b.classList.remove('ll-btn-primary', 'active'); b.classList.add('ll-btn-outline'); });
                this.classList.remove('ll-btn-outline');
                this.classList.add('ll-btn-primary', 'active');
                filterAndSort();
            });
        });

        searchInput.addEventListener('input', filterAndSort);
        sortSelect.addEventListener('change', filterAndSort);

        // Discussion type buttons in modal
        document.querySelectorAll('.disc-type-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.disc-type-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Post discussion
        document.getElementById('postDiscussionBtn').addEventListener('click', function() {
            const title = document.getElementById('discTitle').value;
            const content = document.getElementById('discContent').value;
            if (!title || !content) { alert('Please fill in the title and content.'); return; }
            var modal = bootstrap.Modal.getInstance(document.getElementById('newDiscussionModal'));
            modal.hide();
            var toast = new bootstrap.Toast(document.getElementById('portalToast'));
            toast.show();
            document.getElementById('discTitle').value = '';
            document.getElementById('discContent').value = '';
        });
    })();
</script>
}
