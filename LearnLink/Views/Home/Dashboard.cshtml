@{
    ViewData["Title"] = "Dashboard";
    ViewData["ActivePage"] = "Dashboard";

    var isAdmin = User.IsInRole("SuperAdmin");
    var isContributor = User.IsInRole("Contributor");
    var isManager = User.IsInRole("Manager");
    var canUpload = isAdmin || isContributor || isManager;
    var canAdmin = isAdmin; // Added definition

    var stats = ViewBag.Stats as LearnLink.Models.DashboardStatsViewModel;
    var recentResources = ViewBag.RecentResources as List<LearnLink.Models.ResourceViewModel> ?? new List<LearnLink.Models.ResourceViewModel>();
    var pendingApprovals = ViewBag.PendingApprovals as List<LearnLink.Models.ResourceViewModel> ?? new List<LearnLink.Models.ResourceViewModel>();
    var recentActivity = ViewBag.RecentActivity as List<LearnLink.Models.ActivityViewModel> ?? new List<LearnLink.Models.ActivityViewModel>();
}

<!-- Page Header -->
<div class="ll-page-header">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
        <div>
            <h1 class="ll-page-title">Dashboard</h1>
            <div class="ll-breadcrumb">
                <a href="#">Home</a>
                <i class="bi bi-chevron-right small"></i>
                <span>Dashboard</span>
            </div>
        </div>
        @if (canUpload)
        {
        <div class="d-flex gap-2">
            <a href="@Url.Action("Upload", "Home")" class="ll-btn ll-btn-primary">
                <i class="bi bi-cloud-arrow-up"></i>
                Upload Resource
            </a>
        </div>
        }
    </div>
</div>

<!-- Stats Cards -->
<div class="row g-4 mb-4">
    <div class="col-6 col-sm-6 col-xl-3">
        <div class="ll-stat-card">
            <div class="ll-stat-icon primary">
                <i class="bi bi-folder2-open"></i>
            </div>
            <div class="ll-stat-content">
                <div class="ll-stat-value">@(stats?.TotalResources.ToString("N0") ?? "0")</div>
                <div class="ll-stat-label">Total Resources</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-sm-6 col-xl-3">
        <div class="ll-stat-card">
            <div class="ll-stat-icon success">
                <i class="bi bi-download"></i>
            </div>
            <div class="ll-stat-content">
                <div class="ll-stat-value">@(stats?.TotalDownloads.ToString("N0") ?? "0")</div>
                <div class="ll-stat-label">Total Downloads</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-sm-6 col-xl-3">
        <div class="ll-stat-card">
            <div class="ll-stat-icon warning">
                <i class="bi bi-people"></i>
            </div>
            <div class="ll-stat-content">
                <div class="ll-stat-value">@(stats?.ActiveUsers.ToString("N0") ?? "0")</div>
                <div class="ll-stat-label">Active Users</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-sm-6 col-xl-3">
        <div class="ll-stat-card">
            <div class="ll-stat-icon info">
                <i class="bi bi-chat-square-text"></i>
            </div>
            <div class="ll-stat-content">
                <div class="ll-stat-value">@(stats?.ActiveDiscussions.ToString("N0") ?? "0")</div>
                <div class="ll-stat-label">Total Discussions</div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    @if (canAdmin || isManager)
    {
    <!-- Pending Approvals -->
    <div class="col-12">
        <div class="ll-card mb-4">
            <div class="ll-card-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
                <h5 class="ll-card-title text-secondary mb-0"><i class="bi bi-hourglass-split me-2"></i>Pending Approvals</h5>
                <span class="badge bg-light text-muted border">@pendingApprovals.Count Pending</span>
            </div>
            <div class="ll-card-body p-0">
                <!-- Desktop: Table view -->
                <div class="table-responsive-xl d-none d-md-block">
                    <table class="ll-table">
                        <thead>
                            <tr>
                                <th>Resource</th>
                                <th>Subject</th>
                                <th>Contributor</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (pendingApprovals.Any())
                            {
                                foreach (var resource in pendingApprovals)
                                {
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center gap-3">
                                            <div style="width: 40px; height: 40px; background: var(--ll-light); border: 1px solid #e2e8f0; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                                <i class="bi @resource.IconClass text-secondary"></i>
                                            </div>
                                            <div>
                                                <div class="fw-medium">@resource.Title</div>
                                                @if (!string.IsNullOrEmpty(resource.FileFormat) || !string.IsNullOrEmpty(resource.FileSize))
                                                {
                                                    <div class="small text-muted">@resource.FileFormat @(string.IsNullOrEmpty(resource.FileFormat) || string.IsNullOrEmpty(resource.FileSize) ? "" : "•") @resource.FileSize</div>
                                                }
                                            </div>
                                        </div>
                                    </td>
                                    <td><span class="ll-tag">@resource.Subject</span></td>
                                    <td>
                                        <div class="d-flex align-items-center gap-2">
                                            <div style="width: 32px; height: 32px; background: var(--ll-light); border: 1px solid #e2e8f0; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; color: var(--ll-secondary);">@resource.UploaderInitials</div>
                                            <span>@resource.Uploader</span>
                                        </div>
                                    </td>
                                    <td>@resource.CreatedAt.ToString("MMM dd, yyyy")</td>
                                    <td>
                                        <div class="d-flex gap-2">
                                            <a href="@Url.Action("ApproveResource", "Home", new { id = resource.Id })" class="ll-btn ll-btn-sm ll-btn-success" title="Approve"><i class="bi bi-check-lg"></i> Approve</a>
                                            <button type="button" class="ll-btn ll-btn-sm ll-btn-danger-outline reject-btn" data-id="@resource.Id" data-title="@resource.Title" title="Reject"><i class="bi bi-x-lg"></i> Reject</button>
                                            <a href="@Url.Action("ResourceDetail", "Home", new { id = resource.Id })" class="ll-btn ll-btn-sm ll-btn-outline" title="View"><i class="bi bi-eye"></i></a>
                                        </div>
                                    </td>
                                </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="text-center py-4 text-muted">
                                        <i class="bi bi-check-circle display-6 d-block mb-2"></i>
                                        All caught up! No pending approvals.
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Mobile: Card list view -->
                <div class="d-md-none">
                    @if (pendingApprovals.Any())
                    {
                        foreach (var resource in pendingApprovals)
                        {
                            <div class="p-3 border-bottom">
                                <div class="d-flex align-items-center gap-3 mb-3">
                                    <div style="width: 40px; height: 40px; background: var(--ll-light); border: 1px solid #e2e8f0; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="bi @resource.IconClass text-secondary"></i>
                                    </div>
                                    <div>
                                        <div class="fw-medium">@resource.Title</div>
                                        @if (!string.IsNullOrEmpty(resource.FileFormat) || !string.IsNullOrEmpty(resource.FileSize))
                                        {
                                            <div class="small text-muted">@resource.FileFormat @(string.IsNullOrEmpty(resource.FileFormat) || string.IsNullOrEmpty(resource.FileSize) ? "" : "•") @resource.FileSize</div>
                                        }
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="ll-tag">@resource.Subject</span>
                                    <div class="text-muted small">@resource.CreatedAt.ToString("MMM dd")</div>
                                </div>
                                <div class="d-flex align-items-center gap-2 mb-3">
                                    <div style="width: 24px; height: 24px; background: var(--ll-light); border: 1px solid #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 600; color: var(--ll-secondary);">@resource.UploaderInitials</div>
                                    <span class="small text-muted">By @resource.Uploader</span>
                                </div>
                                <div class="d-flex gap-2">
                                    <a href="@Url.Action("ApproveResource", "Home", new { id = resource.Id })" class="ll-btn ll-btn-sm ll-btn-success flex-grow-1"><i class="bi bi-check-lg"></i> Approve</a>
                                    <button type="button" class="ll-btn ll-btn-sm ll-btn-danger-outline flex-grow-1 reject-btn" data-id="@resource.Id" data-title="@resource.Title"><i class="bi bi-x-lg"></i> Reject</button>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-check-circle display-6 d-block mb-2"></i>
                            All caught up! No pending approvals.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
    }

    <!-- Recent Resources -->
    <div class="col-12">
        <div class="ll-card">
            <div class="ll-card-header">
                <h5 class="ll-card-title">Recent Resources</h5>
                <a href="@Url.Action("Repository", "Home")" class="ll-btn ll-btn-outline ll-btn-sm">View All</a>
            </div>
            <div class="ll-card-body p-0">
                <!-- Desktop: Table view -->
                <div class="table-responsive">
                    <table class="ll-table">
                        <thead>
                            <tr>
                                <th>Resource</th>
                                <th>Subject</th>
                                <th>Contributor</th>
                                <th>Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var resource in recentResources)
                            {
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center gap-3">
                                        <div style="width: 40px; height: 40px; background: @resource.IconBg; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                            <i class="bi @resource.IconClass @resource.IconColor"></i>
                                        </div>
                                        <div>
                                            <div class="fw-medium">@resource.Title</div>
                                            @if (!string.IsNullOrEmpty(resource.FileFormat) || !string.IsNullOrEmpty(resource.FileSize))
                                            {
                                                <div class="small text-muted">@resource.FileFormat @(string.IsNullOrEmpty(resource.FileFormat) || string.IsNullOrEmpty(resource.FileSize) ? "" : "•") @resource.FileSize</div>
                                            }
                                        </div>
                                    </div>
                                </td>
                                <td><span class="ll-tag">@resource.Subject</span></td>
                                <td>@resource.Uploader</td>
                                <td>@resource.CreatedAt.ToString("MMM dd, yyyy")</td>
                                <td>@resource.Status</td>
                            </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <!-- Mobile: Card list view -->
                <div class="ll-mobile-card-list">
                    @foreach (var resource in recentResources)
                    {
                    <div class="ll-mobile-card-item"
                         data-res-title="@resource.Title"
                         data-res-format="@resource.FileFormat"
                         data-res-size="@resource.FileSize"
                         data-res-subject="@resource.Subject"
                         data-res-uploader="@resource.Uploader"
                         data-res-date="@resource.CreatedAt.ToString("MMM dd, yyyy")"
                         data-res-status="@resource.Status"
                         data-res-grade="@resource.GradeLevel"
                         data-res-type="@resource.ResourceType">
                        <div class="ll-mobile-card-icon" style="background: @resource.IconBg;">
                            <i class="bi @resource.IconClass @resource.IconColor"></i>
                        </div>
                        <div class="ll-mobile-card-info">
                            <div class="ll-mobile-card-title">@resource.Title</div>
                            @if (!string.IsNullOrEmpty(resource.FileFormat) || !string.IsNullOrEmpty(resource.FileSize))
                            {
                                <div class="ll-mobile-card-sub">@resource.FileFormat @(string.IsNullOrEmpty(resource.FileFormat) || string.IsNullOrEmpty(resource.FileSize) ? "" : "•") @resource.FileSize</div>
                            }
                        </div>
                        <div class="ll-mobile-card-chevron">
                            <i class="bi bi-chevron-right"></i>
                        </div>
                    </div>
                    }
                </div>
            </div>
        </div>
    </div>


</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050; animation: slideIn 0.3s ease-out;">
        <div class="ll-card shadow-lg" style="min-width: 320px; border: none; overflow: hidden;">
            <div class="ll-card-header py-2 d-flex justify-content-between align-items-center" style="background: var(--ll-success); color: #fff;">
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-check-circle-fill"></i>
                    <span class="fw-bold">@TempData["SuccessTitle"]</span>
                </div>
                <button type="button" class="btn-close btn-close-white small" onclick="this.parentElement.parentElement.parentElement.remove()" style="font-size: 0.65rem;"></button>
            </div>
            <div class="ll-card-body py-3" style="background: #fff;">
                <p class="mb-0 small text-dark">@TempData["SuccessMessage"]</p>
            </div>
        </div>
    </div>

    <style>
        @@keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>

    <script>
        // Auto-remove after 5 seconds
        setTimeout(() => {
            const toast = document.querySelector('.position-fixed.bottom-0.end-0');
            if (toast) {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                toast.style.transition = 'all 0.5s ease';
                setTimeout(() => toast.remove(), 500);
            }
        }, 5000);
    </script>
}

<!-- Rejection Reason Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="rejectForm" method="post">
                <div class="modal-header" style="background: #fee2e2; border-bottom: none;">
                    <div class="d-flex align-items-center gap-2">
                        <div style="width: 36px; height: 36px; background: #fecaca; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-x-circle-fill text-danger"></i>
                        </div>
                        <h6 class="modal-title fw-bold mb-0">Reject Resource</h6>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">You are about to reject <strong id="rejectResourceTitle"></strong>. Please provide a reason for the contributor.</p>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Reason for Rejection</label>
                        <textarea class="form-control" name="reason" id="rejectReason" rows="3" placeholder="e.g. Content does not meet quality standards, missing references, incorrect formatting..." style="resize: none;"></textarea>
                    </div>
                    <div class="alert alert-warning py-2 small mb-0">
                        <i class="bi bi-info-circle me-1"></i> The contributor will be notified with this reason.
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger"><i class="bi bi-x-lg me-1"></i>Reject Resource</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
<script>
    document.querySelectorAll('.reject-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var id = this.getAttribute('data-id');
            var title = this.getAttribute('data-title');
            document.getElementById('rejectResourceTitle').textContent = '"' + title + '"';
            document.getElementById('rejectForm').action = '/Home/RejectResource?id=' + id;
            document.getElementById('rejectReason').value = '';
            new bootstrap.Modal(document.getElementById('rejectModal')).show();
        });
    });
</script>
}
