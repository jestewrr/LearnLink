@{
    ViewData["Title"] = "My Uploads";
    ViewData["ActivePage"] = "MyUploads";

    var uploads = ViewBag.Uploads as List<LearnLink.Models.ResourceViewModel> ?? new List<LearnLink.Models.ResourceViewModel>();
    var totalUploads = (int)(ViewBag.TotalUploads ?? 0);
    var publishedCount = (int)(ViewBag.PublishedCount ?? 0);
    var pendingCount = (int)(ViewBag.PendingCount ?? 0);
    var draftCount = (int)(ViewBag.DraftCount ?? 0);
    var rejectedCount = (int)(ViewBag.RejectedCount ?? 0);
}

<!-- Page Header -->
<div class="ll-page-header">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
        <div>
            <h1 class="ll-page-title">My Uploads</h1>
            <div class="ll-breadcrumb">
                <a href="@Url.Action("Dashboard", "Home")">Home</a>
                <i class="bi bi-chevron-right small"></i>
                <span>My Uploads</span>
            </div>
        </div>
        <div class="d-flex gap-2">
            <a href="@Url.Action("Upload", "Home")" class="ll-btn ll-btn-primary">
                <i class="bi bi-cloud-arrow-up"></i>
                Upload New
            </a>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row g-4 mb-4">
    <div class="col-6 col-sm-6 col-xl-3">
        <div class="ll-stat-card">
            <div class="ll-stat-icon primary">
                <i class="bi bi-file-earmark"></i>
            </div>
            <div class="ll-stat-content">
                <div class="ll-stat-value">@totalUploads</div>
                <div class="ll-stat-label">Total Uploads</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-sm-6 col-xl-3">
        <div class="ll-stat-card">
            <div class="ll-stat-icon success">
                <i class="bi bi-check-circle"></i>
            </div>
            <div class="ll-stat-content">
                <div class="ll-stat-value">@publishedCount</div>
                <div class="ll-stat-label">Published</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-sm-6 col-xl-3">
        <div class="ll-stat-card">
            <div class="ll-stat-icon warning">
                <i class="bi bi-hourglass-split"></i>
            </div>
            <div class="ll-stat-content">
                <div class="ll-stat-value">@pendingCount</div>
                <div class="ll-stat-label">Pending Review</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-sm-6 col-xl-3">
        <div class="ll-stat-card">
            <div class="ll-stat-icon info">
                <i class="bi bi-pencil-square"></i>
            </div>
            <div class="ll-stat-content">
                <div class="ll-stat-value">@draftCount</div>
                <div class="ll-stat-label">Drafts</div>
            </div>
        </div>
    </div>
</div>

<!-- Filter Tabs -->
<div class="ll-card mb-4">
    <div class="ll-card-body py-2">
        <div class="d-flex flex-wrap gap-2 align-items-center">
            <button class="ll-btn ll-btn-primary ll-btn-sm upload-filter-btn active" data-status="">All (@totalUploads)</button>
            <button class="ll-btn ll-btn-outline ll-btn-sm upload-filter-btn" data-status="Published">Published (@publishedCount)</button>
            <button class="ll-btn ll-btn-outline ll-btn-sm upload-filter-btn" data-status="Pending">Pending (@pendingCount)</button>
            <button class="ll-btn ll-btn-outline ll-btn-sm upload-filter-btn" data-status="Draft">Drafts (@draftCount)</button>
            <button class="ll-btn ll-btn-outline ll-btn-sm upload-filter-btn" data-status="Rejected">Rejected (@rejectedCount)</button>
            <div class="ms-auto d-flex gap-2">
                <div class="position-relative">
                    <i class="bi bi-search position-absolute top-50 translate-middle-y ms-3 text-muted"></i>
                    <input type="text" class="ll-form-control ps-5" id="uploadSearchInput" placeholder="Search my uploads..." style="width: 200px; min-width: 0;">
                </div>
                <select class="ll-form-control ll-form-select" id="uploadSortSelect" style="width: auto;">
                    <option value="recent">Most Recent</option>
                    <option value="views">Most Views</option>
                    <option value="downloads">Most Downloads</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Uploads Table -->
<div class="ll-card">
    <div class="ll-card-body p-0">
        <div class="table-responsive-xl">
            <table class="ll-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" class="form-check-input" id="selectAll"></th>
                        <th>Resource</th>
                        <th>Subject</th>
                        <th>Status</th>
                        <th>Views</th>
                        <th>Downloads</th>
                        <th>Rating</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="uploadsTableBody">
                    @foreach (var upload in uploads)
                    {
                    <tr class="upload-row @(upload.Status == "Draft" ? "bg-light" : upload.Status == "Rejected" ? "bg-light" : "")" data-id="@upload.Id" data-status="@upload.Status" data-title="@upload.Title.ToLower()">
                        <td><input type="checkbox" class="form-check-input row-checkbox" data-id="@upload.Id"></td>
                        <td>
                            <div class="d-flex align-items-center gap-3">
                                <div style="width: 40px; height: 40px; background: @upload.IconBg; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi @upload.IconClass @upload.IconColor"></i>
                                </div>
                                <div>
                                    <div class="fw-medium @(upload.Status == "Draft" || upload.Status == "Rejected" ? "text-muted" : "")">@upload.Title @(upload.Status == "Draft" ? "(Draft)" : upload.Status == "Rejected" ? "(Rejected)" : "")</div>
                                    <small class="text-muted">@upload.FileFormat • @upload.FileSize</small>
                                </div>
                            </div>
                        </td>
                        <td><span class="ll-tag">@upload.Subject</span></td>
                        <td>
                            @{
                                var statusColor = upload.Status switch
                                {
                                    "Published" => "text-success",
                                    "Pending" => "text-warning",
                                    "Rejected" => "text-danger",
                                    "Draft" => "text-muted",
                                    _ => "text-secondary"
                                };
                            }
                            <span class="@statusColor fw-medium">@upload.Status</span>
                        </td>
                        <td>@(upload.ViewCount > 0 ? upload.ViewCount.ToString("N0") : "-")</td>
                        <td>@(upload.DownloadCount > 0 ? upload.DownloadCount.ToString("N0") : "-")</td>
                        <td>
                            @if (upload.Rating > 0)
                            {
                            <div class="d-flex align-items-center gap-1">
                                <i class="bi bi-star-fill text-warning small"></i>
                                <span>@upload.Rating.ToString("0.0")</span>
                            </div>
                            }
                            else
                            {
                            <span>-</span>
                            }
                        </td>
                        <td>@upload.CreatedAt.ToString("MMM dd, yyyy")</td>
                        <td>
                            <div class="dropdown">
                                <button class="ll-btn ll-btn-outline ll-btn-sm ll-btn-icon" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    @if (upload.Status == "Draft")
                                    {
                                        <li><a class="dropdown-item" href="@Url.Action("Upload", "Home", new { id = upload.Id })"><i class="bi bi-pencil me-2"></i>Continue Editing</a></li>
                                        <li><a class="dropdown-item" href="#"><i class="bi bi-send me-2"></i>Submit for Review</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger delete-resource-btn" href="javascript:void(0)" data-id="@upload.Id"><i class="bi bi-trash me-2"></i>Discard</a></li>
                                    }
                                    else if (upload.Status == "Pending")
                                    {
                                        <li><a class="dropdown-item" href="@Url.Action("ResourceDetail", "Home", new { id = upload.Id })"><i class="bi bi-eye me-2"></i>View</a></li>
                                        @if (User.IsInRole("SuperAdmin") || User.IsInRole("Manager"))
                                        {
                                        <li><a class="dropdown-item" href="@Url.Action("Upload", "Home", new { id = upload.Id })"><i class="bi bi-pencil me-2"></i>Edit</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="@Url.Action("RejectResource", "Home", new { id = upload.Id })"><i class="bi bi-x-circle me-2"></i>Reject</a></li>
                                        }
                                        else
                                        {
                                        <li><span class="dropdown-item text-muted"><i class="bi bi-hourglass-split me-2"></i>Awaiting Manager Review</span></li>
                                        }
                                    }
                                    else
                                    {
                                        <li><a class="dropdown-item" href="@Url.Action("ResourceDetail", "Home", new { id = upload.Id })"><i class="bi bi-eye me-2"></i>View</a></li>
                                        <li><a class="dropdown-item" href="#"><i class="bi bi-bar-chart me-2"></i>Analytics</a></li>
                                        @if (User.IsInRole("SuperAdmin") || User.IsInRole("Manager"))
                                        {
                                        <li><a class="dropdown-item" href="@Url.Action("Upload", "Home", new { id = upload.Id })"><i class="bi bi-pencil me-2"></i>Edit</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger delete-resource-btn" href="javascript:void(0)" data-id="@upload.Id"><i class="bi bi-trash me-2"></i>Delete</a></li>
                                        }
                                    }
                                </ul>
                            </div>
                        </td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
        <!-- Mobile: Card list view -->
        <div class="ll-mobile-card-list">
            @foreach (var upload in uploads)
            {
                var isManagerOrAdmin = User.IsInRole("SuperAdmin") || User.IsInRole("Manager");
                var mobileActions = (upload.Status, isManagerOrAdmin) switch
                {
                    ("Draft", _) => "Continue Editing|Submit for Review|Discard",
                    ("Pending", true) => "View|Edit|Reject",
                    ("Pending", false) => "View|Awaiting Manager Review",
                    (_, true) => "View|Edit|Analytics|Delete",
                    _ => "View|Analytics"
                };
            <div class="ll-mobile-card-item upload-row-mobile"
                 data-id="@upload.Id"
                 data-status="@upload.Status"
                 data-title="@upload.Title.ToLower()"
                 data-res-title="@upload.Title"
                 data-res-format="@upload.FileFormat"
                 data-res-size="@upload.FileSize"
                 data-res-subject="@upload.Subject"
                 data-res-status="@upload.Status"
                 data-res-views="@(upload.ViewCount > 0 ? upload.ViewCount.ToString("N0") : "-")"
                 data-res-downloads="@(upload.DownloadCount > 0 ? upload.DownloadCount.ToString("N0") : "-")"
                 data-res-rating="@(upload.Rating > 0 ? upload.Rating.ToString("0.0") : "-")"
                 data-res-date="@upload.CreatedAt.ToString("MMM dd, yyyy")"
                 data-actions="@mobileActions">
                <div class="ll-mobile-card-icon" style="background: @upload.IconBg;">
                    <i class="bi @upload.IconClass @upload.IconColor"></i>
                </div>
                <div class="ll-mobile-card-info">
                    <div class="ll-mobile-card-title">@upload.Title @(upload.Status == "Draft" ? "(Draft)" : "")</div>
                    <div class="ll-mobile-card-sub">@upload.FileFormat • @upload.FileSize • <span class="@(upload.Status == "Published" ? "text-success" : upload.Status == "Pending" ? "text-warning" : upload.Status == "Rejected" ? "text-danger" : "text-muted")">@upload.Status</span></div>
                </div>
                <div class="ll-mobile-card-chevron">
                    <i class="bi bi-chevron-right"></i>
                </div>
            </div>
            }
        </div>
    </div>
    <div class="ll-card-body border-top">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="text-muted small" id="uploadsPaginationInfo">Showing @uploads.Count of @totalUploads uploads</div>
            <nav aria-label="Uploads pagination">
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item disabled"><a class="page-link" href="#"><i class="bi bi-chevron-left"></i></a></li>
                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                    <li class="page-item"><a class="page-link" href="#"><i class="bi bi-chevron-right"></i></a></li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body py-4 text-center">
                <div class="ll-stat-icon info mx-auto mb-3" style="width: 64px; height: 64px; font-size: 1.5rem; background: #fee2e2; color: #ef4444;">
                    <i class="bi bi-trash"></i>
                </div>
                <h5 class="fw-bold mb-2">Are you sure?</h5>
                <p class="text-muted mb-0" id="deleteModalMessage">This action cannot be undone. This will permanently delete the selected resource(s).</p>
            </div>
            <div class="modal-footer border-0 pt-0 flex-column gap-2">
                <button type="button" class="ll-btn ll-btn-danger w-100" id="confirmDeleteBtn">Delete Permanently</button>
                <button type="button" class="ll-btn ll-btn-outline w-100" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    (function() {
        const filterBtns = document.querySelectorAll('.upload-filter-btn');
        const searchInput = document.getElementById('uploadSearchInput');
        const rows = document.querySelectorAll('.upload-row');
        const selectAll = document.getElementById('selectAll');
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        let selectedIds = [];

        function filterUploads() {
            const activeBtn = document.querySelector('.upload-filter-btn.active');
            const statusFilter = activeBtn ? activeBtn.dataset.status : '';
            const query = searchInput.value.toLowerCase();
            let count = 0;

            rows.forEach(row => {
                const matchStatus = !statusFilter || row.dataset.status === statusFilter;
                const matchSearch = !query || row.dataset.title.includes(query);
                row.style.display = (matchStatus && matchSearch) ? '' : 'none';
                if (matchStatus && matchSearch) count++;
            });

            document.getElementById('uploadsPaginationInfo').textContent = 'Showing ' + count + ' of @totalUploads uploads';
        }

        filterBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                filterBtns.forEach(b => { b.classList.remove('ll-btn-primary', 'active'); b.classList.add('ll-btn-outline'); });
                this.classList.remove('ll-btn-outline');
                this.classList.add('ll-btn-primary', 'active');
                filterUploads();
            });
        });

        searchInput.addEventListener('input', filterUploads);

        // Select all checkbox
        selectAll.addEventListener('change', function() {
            document.querySelectorAll('.row-checkbox').forEach(cb => {
                if (cb.closest('tr').style.display !== 'none') {
                    cb.checked = this.checked;
                    if (this.checked) {
                        triggerDeleteConfirmation([parseInt(cb.dataset.id)]);
                    }
                }
            });
        });

        // Individual resource checkboxes
        document.querySelectorAll('.row-checkbox').forEach(cb => {
            cb.addEventListener('change', function() {
                if (this.checked) {
                    triggerDeleteConfirmation([parseInt(this.dataset.id)]);
                }
            });
        });

        // Dropdown actions delete
        document.querySelectorAll('.delete-resource-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                triggerDeleteConfirmation([parseInt(this.dataset.id)]);
            });
        });

        function triggerDeleteConfirmation(ids) {
            selectedIds = ids;
            document.getElementById('deleteModalMessage').textContent = ids.length > 1 
                ? `Are you sure you want to delete ${ids.length} selected resources?`
                : "This action cannot be undone. This will permanently delete the selected resource.";
            deleteModal.show();
        }

        confirmDeleteBtn.addEventListener('click', async function() {
            if (selectedIds.length === 0) return;

            const originalText = confirmDeleteBtn.innerHTML;
            confirmDeleteBtn.disabled = true;
            confirmDeleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Deleting...';

            const params = new URLSearchParams();
            selectedIds.forEach(id => params.append('ids', id));

            try {
                const response = await fetch('@Url.Action("DeleteResource", "Home")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                });

                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert(result.message);
                    deleteModal.hide();
                }
            } catch (error) {
                alert('An error occurred during deletion.');
                deleteModal.hide();
            } finally {
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.innerHTML = originalText;
            }
        });
    })();
</script>
}
