@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Resource Detail";
    ViewData["ActivePage"] = "Repository";

    var resource = ViewBag.Resource as LearnLink.Models.ResourceViewModel;
    if (resource == null) return;
    var related = ViewBag.RelatedResources as List<LearnLink.Models.ResourceViewModel> ?? new List<LearnLink.Models.ResourceViewModel>();
    var fileUrl = ViewBag.FileUrl as string ?? string.Empty;
    var canPreview = (bool?)(ViewBag.CanPreview ?? false) ?? false;

    string Normal(string f) => f?.TrimStart('.').ToUpper() ?? "";

    string GetThumbnailGradient(string format) => Normal(format) switch
    {
        "PDF" => "background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%)",
        "DOCX" or "DOC" => "background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)",
        "PPTX" or "PPT" => "background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%)",
        "XLSX" or "XLS" => "background: linear-gradient(135deg, #10b981 0%, #059669 100%)",
        _ => "background: linear-gradient(135deg, #8b5cf6) 0%, #7c3aed 100%)"
    };

    string GetThumbnailIcon(string format) => Normal(format) switch
    {
        "PDF" => "bi-file-earmark-pdf",
        "DOCX" or "DOC" => "bi-file-earmark-word",
        "PPTX" or "PPT" => "bi-file-earmark-ppt",
        "XLSX" or "XLS" => "bi-file-earmark-excel",
        _ => "bi-file-earmark"
    };

    string GetFormatLabel(string format) => Normal(format) switch
    {
        "PDF" => "PDF Document",
        "DOCX" or "DOC" => "Word Document",
        "PPTX" or "PPT" => "PowerPoint Presentation",
        "XLSX" or "XLS" => "Excel Spreadsheet",
        _ => "Document"
    };
}

<!-- Breadcrumb -->
<div class="ll-page-header">
    <div class="ll-breadcrumb">
        <a href="@Url.Action("Dashboard", "Home")">Home</a>
        <i class="bi bi-chevron-right small"></i>
        <a href="@Url.Action("Repository", "Home")">Knowledge Repository</a>
        <i class="bi bi-chevron-right small"></i>
        <span>@resource.Title</span>
    </div>
</div>

<div class="row g-4">
    <!-- Main Content Column -->
    <div class="col-lg-8">

        @if (TempData["ErrorMessage"] != null)
        {
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        }

        <!-- Meta bar (Scribd-style) -->
        <div class="ll-detail-meta-bar">
            @if (resource.RatingCount > 0)
            {
                <span><i class="bi bi-hand-thumbs-up"></i> @resource.RatingCount ratings</span>
                <span class="ll-detail-meta-dot">·</span>
            }
            <span><i class="bi bi-file-earmark"></i> @GetFormatLabel(resource.FileFormat)</span>
            <span class="ll-detail-meta-dot">·</span>
            <span><i class="bi bi-eye"></i> @resource.ViewCount.ToString("N0") views</span>
        </div>

        <!-- Title -->
        <h1 class="ll-detail-title">@resource.Title</h1>

        <!-- Uploader -->
        <div class="ll-detail-uploader">
            <div class="ll-detail-uploader-avatar" style="@(string.IsNullOrEmpty(resource.UploaderColor) ? "background: linear-gradient(135deg, var(--ll-primary), var(--ll-primary-dark))" : resource.UploaderColor)">
                @resource.UploaderInitials
            </div>
            <div>
                <div class="ll-detail-uploader-name">Uploaded by <strong>@resource.Uploader</strong></div>
                <div class="ll-detail-uploader-date">@resource.CreatedAt.ToString("MMMM dd, yyyy")</div>
            </div>
        </div>

        <!-- Tags -->
        <div class="ll-detail-tags">
            <span class="ll-detail-tag">@resource.Subject</span>
            <span class="ll-detail-tag">@resource.GradeLevel</span>
            <span class="ll-detail-tag">@resource.ResourceType</span>
            <span class="ll-detail-tag">@resource.Quarter</span>
        </div>

        <!-- Description -->
        <div class="ll-detail-description">
            <p>@resource.Description</p>
        </div>

        <!-- Action Bar -->
        <div class="ll-detail-actions">
            <button class="ll-detail-action-btn ll-detail-action-like @(resource.IsLiked ? "liked" : "")" id="likeBtn" onclick="toggleLike(this, @resource.Id)">
                <i class="bi @(resource.IsLiked ? "bi-heart-fill" : "bi-heart")"></i>
                <span>@(resource.IsLiked ? "Liked" : "Like")</span>
            </button>

            <div class="ll-detail-action-rating" id="ratingWidget">
                <span class="ll-detail-rating-label">Rate:</span>
                @for (int i = 1; i <= 5; i++)
                {
                    <i class="bi bi-star ll-detail-star" data-value="@i" onclick="setRating(@resource.Id, @i)"></i>
                }
                @if (resource.Rating > 0)
                {
                    <span class="ll-detail-rating-value" id="ratingScore">@resource.Rating.ToString("0.0")</span>
                }
            </div>

            <button class="ll-detail-action-btn ll-detail-action-download" onclick="downloadResource(@resource.Id)">
                <i class="bi bi-download"></i>
                <span>Download</span>
            </button>

            <button class="ll-detail-action-btn ll-detail-action-save @(resource.IsSaved ? "saved" : "")" id="saveBtn" onclick="toggleSave(this, @resource.Id)">
                <i class="bi @(resource.IsSaved ? "bi-bookmark-fill" : "bi-bookmark")"></i>
                <span>@(resource.IsSaved ? "Saved" : "Save for later")</span>
            </button>
        </div>

        <!-- Document Preview Area -->
        <div class="ll-detail-preview">
            <div class="ll-detail-preview-header">
                <div style="@GetThumbnailGradient(resource.FileFormat)" class="ll-detail-preview-icon-wrap">
                    <i class="bi @GetThumbnailIcon(resource.FileFormat)"></i>
                </div>
                <div class="ll-detail-preview-info">
                    <div class="ll-detail-preview-filename">@resource.Title.@resource.FileFormat.ToLower()</div>
                    <div class="ll-detail-preview-filesize">@resource.FileSize · @resource.FileFormat.ToUpper()</div>
                </div>
            </div>
            @{
                var fmt = Normal(resource.FileFormat);
                var isOffice = fmt == "DOCX" || fmt == "DOC" || fmt == "PPTX" || fmt == "PPT" || fmt == "XLSX" || fmt == "XLS";
                var hasFile = canPreview && !string.IsNullOrWhiteSpace(fileUrl);
                var canUseGoogleViewer = fileUrl.StartsWith("http", StringComparison.OrdinalIgnoreCase);
                var proxyUrl = Url.Action("DownloadResource", "Home", new { id = resource.Id, inline = true }) ?? fileUrl;
                
                string readUrl = proxyUrl;
                if (isOffice && canUseGoogleViewer) {
                    readUrl = "https://docs.google.com/viewer?url=" + Uri.EscapeDataString(fileUrl);
                } 
            }
            @if (!hasFile)
            {
                <div class="ll-detail-preview-body d-flex flex-column align-items-center justify-content-center" style="background: #f8f9fa; height: 280px;">
                    <i class="bi bi-cloud-slash" style="font-size: 3rem; color: #adb5bd;"></i>
                    <p class="text-muted mt-3 mb-0">No file has been attached to this resource yet.</p>
                </div>
            }
            else if (fmt == "MP4")
            {
                <div class="ll-detail-preview-body p-0" style="height: 500px; background: #000; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center;">
                    <video controls style="max-width: 100%; max-height: 100%;">
                        <source src="@Url.Action("DownloadResource", "Home", new { id = resource.Id, inline = true })" type="video/mp4" />
                        Your browser does not support the video tag.
                    </video>
                </div>
            }
            else
            {
                <div class="ll-detail-preview-body d-flex flex-column align-items-center justify-content-center" style="background: #f8f9fa; min-height: 350px; border-bottom-left-radius: 16px; border-bottom-right-radius: 16px;">
                    <div style="@GetThumbnailGradient(resource.FileFormat); width: 90px; height: 110px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
                        <i class="bi @GetThumbnailIcon(resource.FileFormat)" style="font-size: 3.5rem; color: white;"></i>
                    </div>
                    <h5 class="fw-bold mb-2">@resource.Title.@resource.FileFormat.ToLower()</h5>
                    <p class="text-muted mb-4 text-center px-4" style="max-width: 500px;">Click the button below to open the secure reader in a new tab, or download the resource to your device.</p>
                    <div class="d-flex flex-wrap justify-content-center gap-3">
                        <a href="@readUrl" target="_blank" class="ll-btn ll-btn-primary" style="padding: 10px 24px;">
                            <i class="bi bi-eye me-2"></i>Read Resource
                        </a>
                        <button type="button" class="ll-btn ll-btn-outline" onclick="downloadResource(@resource.Id)" style="padding: 10px 24px;">
                            <i class="bi bi-download me-2"></i>Download
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Sidebar Column -->
    <div class="col-lg-4">
        <!-- Stats Card -->
        <div class="ll-detail-sidebar-card">
            <h6 class="ll-detail-sidebar-title">Document Stats</h6>
            <div class="ll-detail-stat-grid">
                <div class="ll-detail-stat-item">
                    <div class="ll-detail-stat-icon" style="background: #dbeafe; color: #3b82f6;">
                        <i class="bi bi-eye"></i>
                    </div>
                    <div>
                        <div class="ll-detail-stat-number">@resource.ViewCount.ToString("N0")</div>
                        <div class="ll-detail-stat-label">Views</div>
                    </div>
                </div>
                <div class="ll-detail-stat-item">
                    <div class="ll-detail-stat-icon" style="background: #d1fae5; color: #10b981;">
                        <i class="bi bi-download"></i>
                    </div>
                    <div>
                        <div class="ll-detail-stat-number">@resource.DownloadCount.ToString("N0")</div>
                        <div class="ll-detail-stat-label">Downloads</div>
                    </div>
                </div>
                <div class="ll-detail-stat-item">
                    <div class="ll-detail-stat-icon" style="background: #fef3c7; color: #f59e0b;">
                        <i class="bi bi-star-fill"></i>
                    </div>
                    <div>
                        <div class="ll-detail-stat-number" id="ratingStatsValue">@(resource.Rating > 0 ? resource.Rating.ToString("0.0") : "N/A")</div>
                        <div class="ll-detail-stat-label" id="ratingStatsCount">Rating (@resource.RatingCount)</div>
                    </div>
                </div>
                <div class="ll-detail-stat-item">
                    <div class="ll-detail-stat-icon" style="background: #fce7f3; color: #ec4899;">
                        <i class="bi bi-heart-fill"></i>
                    </div>
                    <div>
                        <div class="ll-detail-stat-number" id="likeCount">@resource.LikeCount.ToString("N0")</div>
                        <div class="ll-detail-stat-label">Likes</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Details Card -->
        <div class="ll-detail-sidebar-card">
            <h6 class="ll-detail-sidebar-title">Details</h6>
            <div class="ll-detail-info-list">
                <div class="ll-detail-info-row">
                    <span class="ll-detail-info-label">Format</span>
                    <span class="ll-detail-info-value">@GetFormatLabel(resource.FileFormat)</span>
                </div>
                <div class="ll-detail-info-row">
                    <span class="ll-detail-info-label">File Size</span>
                    <span class="ll-detail-info-value">@resource.FileSize</span>
                </div>
                <div class="ll-detail-info-row">
                    <span class="ll-detail-info-label">Subject</span>
                    <span class="ll-detail-info-value">@resource.Subject</span>
                </div>
                <div class="ll-detail-info-row">
                    <span class="ll-detail-info-label">Grade Level</span>
                    <span class="ll-detail-info-value">@resource.GradeLevel</span>
                </div>
                <div class="ll-detail-info-row">
                    <span class="ll-detail-info-label">Type</span>
                    <span class="ll-detail-info-value">@resource.ResourceType</span>
                </div>
                <div class="ll-detail-info-row">
                    <span class="ll-detail-info-label">Quarter</span>
                    <span class="ll-detail-info-value">@resource.Quarter</span>
                </div>
                <div class="ll-detail-info-row">
                    <span class="ll-detail-info-label">Status</span>
                    <span class="ll-badge @(resource.Status == "Published" ? "ll-badge-success" : resource.Status == "Pending" ? "ll-badge-warning" : "ll-badge-info")">@resource.Status</span>
                </div>
                <div class="ll-detail-info-row">
                    <span class="ll-detail-info-label">Uploaded</span>
                    <span class="ll-detail-info-value">@resource.CreatedAt.ToString("MMM dd, yyyy")</span>
                </div>
            </div>
        </div>

        <!-- Tags Card -->
        <div class="ll-detail-sidebar-card">
            <h6 class="ll-detail-sidebar-title">Tags</h6>
            <div class="ll-detail-sidebar-tags">
                <span class="ll-detail-sidebar-tag">@resource.Subject</span>
                <span class="ll-detail-sidebar-tag">@resource.GradeLevel</span>
                <span class="ll-detail-sidebar-tag">@resource.ResourceType</span>
                <span class="ll-detail-sidebar-tag">@resource.Quarter</span>
                <span class="ll-detail-sidebar-tag">@resource.FileFormat</span>
                <span class="ll-detail-sidebar-tag">@resource.Uploader</span>
            </div>
        </div>
    </div>
</div>

<!-- Related Resources -->
@if (related.Any())
{
<div class="ll-detail-related">
    <h5 class="ll-detail-related-title">More from @resource.Subject</h5>
    <div class="row g-3">
        @foreach (var r in related)
        {
        <div class="col-sm-6 col-lg-3">
            <a href="@Url.Action("ResourceDetail", "Home", new { id = r.Id })" class="text-decoration-none">
                <div class="ll-resource-card">
                    <div class="ll-resource-thumbnail" style="@GetThumbnailGradient(r.FileFormat)">
                        <i class="bi @GetThumbnailIcon(r.FileFormat)"></i>
                        <span class="ll-resource-type">@r.FileFormat</span>
                    </div>
                    <div class="ll-resource-content">
                        <h5 class="ll-resource-title">@r.Title</h5>
                        <div class="ll-resource-meta">
                            <span><i class="bi bi-download"></i> @r.DownloadCount.ToString("N0")</span>
                            <span><i class="bi bi-eye"></i> @r.ViewCount.ToString("N0")</span>
                            @if (r.Rating > 0)
                            {
                            <span><i class="bi bi-star-fill text-warning"></i> @r.Rating.ToString("0.0")</span>
                            }
                        </div>
                        <div class="ll-resource-tags">
                            <span class="ll-tag">@r.GradeLevel</span>
                            <span class="ll-tag">@r.ResourceType</span>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        }
    </div>
</div>
}

@section Scripts {
<script>
    // Like toggle
    async function toggleLike(btn, id) {
        if (btn.disabled) return;
        btn.disabled = true;

        const formData = new FormData();
        formData.append('id', id);

        try {
            const res = await fetch('@Url.Action("LikeResource", "Home")', { method: 'POST', body: formData });
            const data = await res.json();
            
            if (data.success) {
                var icon = btn.querySelector('i');
                var text = btn.querySelector('span');
                var countEl = document.getElementById('likeCount');

                if (data.isLiked) {
                    btn.classList.add('liked');
                    icon.className = 'bi bi-heart-fill';
                    text.textContent = 'Liked';
                } else {
                    btn.classList.remove('liked');
                    icon.className = 'bi bi-heart';
                    text.textContent = 'Like';
                }
                countEl.textContent = data.count.toLocaleString();
            } else {
                alert('Action failed. Please make sure you are logged in.');
            }
        } catch(e) { /* ignored */ }
        btn.disabled = false;
    }

    // Star rating
    async function setRating(id, value) {
        var stars = document.querySelectorAll('.ll-detail-star');
        // Disable stars temporarily
        stars.forEach(s => s.style.pointerEvents = 'none');

        const formData = new FormData();
        formData.append('id', id);
        formData.append('rating', value);

        try {
            const res = await fetch('@Url.Action("RateResource", "Home")', { method: 'POST', body: formData });
            const data = await res.json();

            if (data.success) {
                // visually update stars
                stars.forEach(function(star, index) {
                    if (index < value) {
                        star.className = 'bi bi-star-fill ll-detail-star active';
                    } else {
                        star.className = 'bi bi-star ll-detail-star';
                    }
                });

                // Show feedback
                var ratingValue = document.getElementById('ratingScore');
                if (!ratingValue) {
                    ratingValue = document.createElement('span');
                    ratingValue.className = 'll-detail-rating-value';
                    ratingValue.id = 'ratingScore';
                    document.getElementById('ratingWidget').appendChild(ratingValue);
                }
                ratingValue.textContent = data.rating;

                // Update right stats card
                document.getElementById('ratingStatsValue').textContent = data.rating;
                document.getElementById('ratingStatsCount').textContent = 'Rating (' + data.count + ')';
            } else {
                alert('Failed to submit rating.');
            }
        } catch(e) { /* ignored */ }
        
        // Re-enable stars
        stars.forEach(s => s.style.pointerEvents = 'auto');
    }

    // Download action — triggers real browser download dialog
    function downloadResource(id) {
        var dlBtn = document.querySelector('.ll-detail-action-download');
        if (dlBtn) {
            var origHTML = dlBtn.innerHTML;
            dlBtn.innerHTML = '<i class="bi bi-clock"></i> <span>Starting...</span>';
            dlBtn.disabled = true;
        }

        window.location.href = '@Url.Action("DownloadResource", "Home")?id=' + id + '&inline=false';

        if (dlBtn) {
            setTimeout(function() {
                dlBtn.innerHTML = '<i class="bi bi-check-circle"></i> <span>Downloaded</span>';
                dlBtn.disabled = false;
                setTimeout(function() {
                    dlBtn.innerHTML = origHTML;
                }, 3000);
            }, 1200);
        }
    }

    // Save toggle
    async function toggleSave(btn, id) {
        if (btn.disabled) return;
        btn.disabled = true;

        const formData = new FormData();
        formData.append('id', id);

        try {
            const res = await fetch('@Url.Action("SaveResource", "Home")', { method: 'POST', body: formData });
            const data = await res.json();

            if (data.success) {
                var icon = btn.querySelector('i');
                var text = btn.querySelector('span');

                if (data.isSaved) {
                    btn.classList.add('saved');
                    icon.className = 'bi bi-bookmark-fill';
                    text.textContent = 'Saved';
                } else {
                    btn.classList.remove('saved');
                    icon.className = 'bi bi-bookmark';
                    text.textContent = 'Save for later';
                }
            } else {
                alert('Action failed. Please verify you are logged in.');
            }
        } catch(e) { /* ignored */ }
        btn.disabled = false;
    }
</script>
}
