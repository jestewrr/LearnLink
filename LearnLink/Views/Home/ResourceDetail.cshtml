@{
    ViewData["Title"] = "Resource Detail";
    ViewData["ActivePage"] = "Repository";

    var resource = ViewBag.Resource as LearnLink.Models.ResourceViewModel;
    var related = ViewBag.RelatedResources as List<LearnLink.Models.ResourceViewModel> ?? new List<LearnLink.Models.ResourceViewModel>();

    string GetThumbnailGradient(string format) => format?.ToUpper() switch
    {
        "PDF" => "background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%)",
        "DOCX" => "background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)",
        "PPTX" => "background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%)",
        "XLSX" => "background: linear-gradient(135deg, #10b981 0%, #059669 100%)",
        _ => "background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)"
    };

    string GetThumbnailIcon(string format) => format?.ToUpper() switch
    {
        "PDF" => "bi-file-earmark-pdf",
        "DOCX" => "bi-file-earmark-word",
        "PPTX" => "bi-file-earmark-ppt",
        "XLSX" => "bi-file-earmark-excel",
        _ => "bi-file-earmark"
    };

    string GetFormatLabel(string format) => format?.ToUpper() switch
    {
        "PDF" => "PDF Document",
        "DOCX" => "Word Document",
        "PPTX" => "PowerPoint Presentation",
        "XLSX" => "Excel Spreadsheet",
        _ => "Document"
    };
}

<!-- Breadcrumb -->
<div class="ll-page-header">
    <div class="ll-breadcrumb">
        <a href="@Url.Action("Dashboard", "Home")">Home</a>
        <i class="bi bi-chevron-right small"></i>
        <a href="@Url.Action("Repository", "Home")">Knowledge Repository</a>
        <i class="bi bi-chevron-right small"></i>
        <span>@resource.Title</span>
    </div>
</div>

<div class="row g-4">
    <!-- Main Content Column -->
    <div class="col-lg-8">
        <!-- Meta bar (Scribd-style) -->
        <div class="ll-detail-meta-bar">
            @if (resource.RatingCount > 0)
            {
                <span><i class="bi bi-hand-thumbs-up"></i> @resource.RatingCount ratings</span>
                <span class="ll-detail-meta-dot">·</span>
            }
            <span><i class="bi bi-file-earmark"></i> @GetFormatLabel(resource.FileFormat)</span>
            <span class="ll-detail-meta-dot">·</span>
            <span><i class="bi bi-eye"></i> @resource.ViewCount.ToString("N0") views</span>
        </div>

        <!-- Title -->
        <h1 class="ll-detail-title">@resource.Title</h1>

        <!-- Uploader -->
        <div class="ll-detail-uploader">
            <div class="ll-detail-uploader-avatar" style="@(string.IsNullOrEmpty(resource.UploaderColor) ? "background: linear-gradient(135deg, var(--ll-primary), var(--ll-primary-dark))" : resource.UploaderColor)">
                @resource.UploaderInitials
            </div>
            <div>
                <div class="ll-detail-uploader-name">Uploaded by <strong>@resource.Uploader</strong></div>
                <div class="ll-detail-uploader-date">@resource.CreatedAt.ToString("MMMM dd, yyyy")</div>
            </div>
        </div>

        <!-- Tags -->
        <div class="ll-detail-tags">
            <span class="ll-detail-tag">@resource.Subject</span>
            <span class="ll-detail-tag">@resource.GradeLevel</span>
            <span class="ll-detail-tag">@resource.ResourceType</span>
            <span class="ll-detail-tag">@resource.Quarter</span>
        </div>

        <!-- Description -->
        <div class="ll-detail-description">
            <p>@resource.Description</p>
        </div>

        <!-- Action Bar -->
        <div class="ll-detail-actions">
            <button class="ll-detail-action-btn ll-detail-action-like" id="likeBtn" onclick="toggleLike(this)">
                <i class="bi bi-heart"></i>
                <span>Like</span>
            </button>

            <div class="ll-detail-action-rating" id="ratingWidget">
                <span class="ll-detail-rating-label">Rate:</span>
                @for (int i = 1; i <= 5; i++)
                {
                    <i class="bi bi-star ll-detail-star" data-value="@i" onclick="setRating(@i)"></i>
                }
                @if (resource.Rating > 0)
                {
                    <span class="ll-detail-rating-value">@resource.Rating.ToString("0.0")</span>
                }
            </div>

            <button class="ll-detail-action-btn ll-detail-action-download" onclick="simulateDownload()">
                <i class="bi bi-download"></i>
                <span>Download</span>
            </button>

            <button class="ll-detail-action-btn ll-detail-action-save" id="saveBtn" onclick="toggleSave(this)">
                <i class="bi bi-bookmark"></i>
                <span>Save for later</span>
            </button>
        </div>

        <!-- Document Preview Area -->
        <div class="ll-detail-preview">
            <div class="ll-detail-preview-header">
                <div style="@GetThumbnailGradient(resource.FileFormat)" class="ll-detail-preview-icon-wrap">
                    <i class="bi @GetThumbnailIcon(resource.FileFormat)"></i>
                </div>
                <div class="ll-detail-preview-info">
                    <div class="ll-detail-preview-filename">@resource.Title.@resource.FileFormat.ToLower()</div>
                    <div class="ll-detail-preview-filesize">@resource.FileSize · @resource.FileFormat.ToUpper()</div>
                </div>
            </div>
            <div class="ll-detail-preview-body" style="@GetThumbnailGradient(resource.FileFormat)">
                <i class="bi @GetThumbnailIcon(resource.FileFormat)" style="font-size: 5rem; opacity: 0.3;"></i>
                <div class="ll-detail-preview-overlay">
                    <button class="ll-btn ll-btn-primary" onclick="simulateDownload()">
                        <i class="bi bi-eye"></i> Read now
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Column -->
    <div class="col-lg-4">
        <!-- Stats Card -->
        <div class="ll-detail-sidebar-card">
            <h6 class="ll-detail-sidebar-title">Document Stats</h6>
            <div class="ll-detail-stat-grid">
                <div class="ll-detail-stat-item">
                    <div class="ll-detail-stat-icon" style="background: #dbeafe; color: #3b82f6;">
                        <i class="bi bi-eye"></i>
                    </div>
                    <div>
                        <div class="ll-detail-stat-number">@resource.ViewCount.ToString("N0")</div>
                        <div class="ll-detail-stat-label">Views</div>
                    </div>
                </div>
                <div class="ll-detail-stat-item">
                    <div class="ll-detail-stat-icon" style="background: #d1fae5; color: #10b981;">
                        <i class="bi bi-download"></i>
                    </div>
                    <div>
                        <div class="ll-detail-stat-number">@resource.DownloadCount.ToString("N0")</div>
                        <div class="ll-detail-stat-label">Downloads</div>
                    </div>
                </div>
                <div class="ll-detail-stat-item">
                    <div class="ll-detail-stat-icon" style="background: #fef3c7; color: #f59e0b;">
                        <i class="bi bi-star-fill"></i>
                    </div>
                    <div>
                        <div class="ll-detail-stat-number">@(resource.Rating > 0 ? resource.Rating.ToString("0.0") : "N/A")</div>
                        <div class="ll-detail-stat-label">Rating (@resource.RatingCount)</div>
                    </div>
                </div>
                <div class="ll-detail-stat-item">
                    <div class="ll-detail-stat-icon" style="background: #fce7f3; color: #ec4899;">
                        <i class="bi bi-heart-fill"></i>
                    </div>
                    <div>
                        <div class="ll-detail-stat-number" id="likeCount">@(resource.RatingCount > 0 ? (resource.RatingCount / 2).ToString() : "0")</div>
                        <div class="ll-detail-stat-label">Likes</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Details Card -->
        <div class="ll-detail-sidebar-card">
            <h6 class="ll-detail-sidebar-title">Details</h6>
            <div class="ll-detail-info-list">
                <div class="ll-detail-info-row">
                    <span class="ll-detail-info-label">Format</span>
                    <span class="ll-detail-info-value">@GetFormatLabel(resource.FileFormat)</span>
                </div>
                <div class="ll-detail-info-row">
                    <span class="ll-detail-info-label">File Size</span>
                    <span class="ll-detail-info-value">@resource.FileSize</span>
                </div>
                <div class="ll-detail-info-row">
                    <span class="ll-detail-info-label">Subject</span>
                    <span class="ll-detail-info-value">@resource.Subject</span>
                </div>
                <div class="ll-detail-info-row">
                    <span class="ll-detail-info-label">Grade Level</span>
                    <span class="ll-detail-info-value">@resource.GradeLevel</span>
                </div>
                <div class="ll-detail-info-row">
                    <span class="ll-detail-info-label">Type</span>
                    <span class="ll-detail-info-value">@resource.ResourceType</span>
                </div>
                <div class="ll-detail-info-row">
                    <span class="ll-detail-info-label">Quarter</span>
                    <span class="ll-detail-info-value">@resource.Quarter</span>
                </div>
                <div class="ll-detail-info-row">
                    <span class="ll-detail-info-label">Status</span>
                    <span class="ll-badge @(resource.Status == "Published" ? "ll-badge-success" : resource.Status == "Pending" ? "ll-badge-warning" : "ll-badge-info")">@resource.Status</span>
                </div>
                <div class="ll-detail-info-row">
                    <span class="ll-detail-info-label">Uploaded</span>
                    <span class="ll-detail-info-value">@resource.CreatedAt.ToString("MMM dd, yyyy")</span>
                </div>
            </div>
        </div>

        <!-- Tags Card -->
        <div class="ll-detail-sidebar-card">
            <h6 class="ll-detail-sidebar-title">Tags</h6>
            <div class="ll-detail-sidebar-tags">
                <span class="ll-detail-sidebar-tag">@resource.Subject</span>
                <span class="ll-detail-sidebar-tag">@resource.GradeLevel</span>
                <span class="ll-detail-sidebar-tag">@resource.ResourceType</span>
                <span class="ll-detail-sidebar-tag">@resource.Quarter</span>
                <span class="ll-detail-sidebar-tag">@resource.FileFormat</span>
                <span class="ll-detail-sidebar-tag">@resource.Uploader</span>
            </div>
        </div>
    </div>
</div>

<!-- Related Resources -->
@if (related.Any())
{
<div class="ll-detail-related">
    <h5 class="ll-detail-related-title">More from @resource.Subject</h5>
    <div class="row g-3">
        @foreach (var r in related)
        {
        <div class="col-sm-6 col-lg-3">
            <a href="@Url.Action("ResourceDetail", "Home", new { id = r.Id })" class="text-decoration-none">
                <div class="ll-resource-card">
                    <div class="ll-resource-thumbnail" style="@GetThumbnailGradient(r.FileFormat)">
                        <i class="bi @GetThumbnailIcon(r.FileFormat)"></i>
                        <span class="ll-resource-type">@r.FileFormat</span>
                    </div>
                    <div class="ll-resource-content">
                        <h5 class="ll-resource-title">@r.Title</h5>
                        <div class="ll-resource-meta">
                            <span><i class="bi bi-download"></i> @r.DownloadCount.ToString("N0")</span>
                            <span><i class="bi bi-eye"></i> @r.ViewCount.ToString("N0")</span>
                            @if (r.Rating > 0)
                            {
                            <span><i class="bi bi-star-fill text-warning"></i> @r.Rating.ToString("0.0")</span>
                            }
                        </div>
                        <div class="ll-resource-tags">
                            <span class="ll-tag">@r.GradeLevel</span>
                            <span class="ll-tag">@r.ResourceType</span>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        }
    </div>
</div>
}

@section Scripts {
<script>
    // Like toggle
    function toggleLike(btn) {
        var icon = btn.querySelector('i');
        var text = btn.querySelector('span');
        var countEl = document.getElementById('likeCount');
        var count = parseInt(countEl.textContent.replace(/,/g, ''));
        if (btn.classList.contains('liked')) {
            btn.classList.remove('liked');
            icon.className = 'bi bi-heart';
            text.textContent = 'Like';
            countEl.textContent = (count - 1).toLocaleString();
        } else {
            btn.classList.add('liked');
            icon.className = 'bi bi-heart-fill';
            text.textContent = 'Liked';
            countEl.textContent = (count + 1).toLocaleString();
        }
    }

    // Star rating
    function setRating(value) {
        var stars = document.querySelectorAll('.ll-detail-star');
        stars.forEach(function(star, index) {
            if (index < value) {
                star.className = 'bi bi-star-fill ll-detail-star active';
            } else {
                star.className = 'bi bi-star ll-detail-star';
            }
        });

        // Show feedback
        var ratingValue = document.querySelector('.ll-detail-rating-value');
        if (!ratingValue) {
            ratingValue = document.createElement('span');
            ratingValue.className = 'll-detail-rating-value';
            document.getElementById('ratingWidget').appendChild(ratingValue);
        }
        ratingValue.textContent = value + '.0';
    }

    // Download simulation
    function simulateDownload() {
        var dlBtn = document.querySelector('.ll-detail-action-download');
        var origHTML = dlBtn.innerHTML;
        dlBtn.innerHTML = '<i class="bi bi-check-circle"></i> <span>Downloaded!</span>';
        dlBtn.classList.add('downloaded');
        setTimeout(function() {
            dlBtn.innerHTML = origHTML;
            dlBtn.classList.remove('downloaded');
        }, 2000);
    }

    // Save toggle
    function toggleSave(btn) {
        var icon = btn.querySelector('i');
        var text = btn.querySelector('span');
        if (btn.classList.contains('saved')) {
            btn.classList.remove('saved');
            icon.className = 'bi bi-bookmark';
            text.textContent = 'Save for later';
        } else {
            btn.classList.add('saved');
            icon.className = 'bi bi-bookmark-fill';
            text.textContent = 'Saved';
        }
    }
</script>
}
